<!DOCTYPE html>
<!--
This is a starter template page. Use this page to start your new project from
scratch. This page gets rid of all links and provides the needed markup only.
-->
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Rules management</title>
    <!-- Tell the browser to be responsive to screen width -->
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.min.css">
    <!-- Ionicons -->
    <link rel="stylesheet" href="bower_components/Ionicons/css/ionicons.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="dist/css/AdminLTE.min.css">
    <!-- AdminLTE Skins. We have chosen the skin-blue for this starter
        page. However, you can choose any other skin. Make sure you
        apply the skin class to the body tag so the changes take effect. -->
    <link rel="stylesheet" href="dist/css/skins/skin-blue.min.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->

    <!-- Google Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic">


    <style>


    </style>
</head>
<!--
BODY TAG OPTIONS:
=================
Apply one or more of the following classes to get the
desired effect
|---------------------------------------------------------|
| SKINS         | skin-blue                               |
|               | skin-black                              |
|               | skin-purple                             |
|               | skin-yellow                             |
|               | skin-red                                |
|               | skin-green                              |
|---------------------------------------------------------|
|LAYOUT OPTIONS | fixed                                   |
|               | layout-boxed                            |
|               | layout-top-nav                          |
|               | sidebar-collapse                        |
|               | sidebar-mini                            |
|---------------------------------------------------------|
-->

<body class="hold-transition skin-blue sidebar-mini">
    <div class="wrapper">

        <!-- Main Header -->
        <header class="main-header">

            <!-- Logo -->
            <a href="#" class="logo">
                <!-- mini logo for sidebar mini 50x50 pixels -->
                <span class="logo-mini"><b>M</b>XG</span>
                <!-- logo for regular state and mobile devices -->
                <span class="logo-lg"><b>MAXGAUGE</b> Realtime monitor</span>
            </a>

            <!-- Header Navbar -->
            <nav class="navbar navbar-static-top" role="navigation">

                <!-- Navbar Right Menu -->

                <!-- search form (Optional) -->

                <!-- Sidebar toggle button-->
                <div class="pull-left">
                    <a href="#" class="sidebar-toggle" data-toggle="push-menu" role="button">
                        <span class="sr-only">Toggle navigation</span>
                    </a>
                </div>

                <div class="navbar-custom-menu pull-right">
                    <ul class="nav navbar-nav">
                        <!-- Control Sidebar Toggle Button -->
                        <li>
                            <a href="#" data-toggle="control-sidebar"><i class="fa fa-gears"></i></a>
                        </li>
                    </ul>
                </div>


                <div class="col-md-2 pull-right">
                    <form action="#" method="get" class="sidebar-form">
                        <div class="input-group">
                            <input type="text" name="q" class="form-control" placeholder="Search...">
                            <span class="input-group-btn">
                  <button type="submit" name="search" id="search-btn" class="btn btn-flat"><i class="fa fa-search"></i>
                  </button>
                </span>
                        </div>
                    </form>
                </div>
                <!-- /.search form -->
            </nav>
        </header>
        <!-- Left side column. contains the logo and sidebar -->
        <aside class="main-sidebar">

            <!-- sidebar: style can be found in sidebar.less -->
            <section class="sidebar">


                <!-- Sidebar Menu -->
                <ul class="sidebar-menu" data-widget="tree">
                    <li class="header">
                        <form>
                            <label class="radio-inline"><input type="radio" class="with-gap" name="optradio">Instance name</label>
                            <label class="radio-inline"><input type="radio" class="with-gap" name="optradio">Business name</label>
                        </form>
                    </li>
                    <!-- Optionally, you can add icons to the links -->
                    <li class="inactive"><a href="realtime_diag.html"><i class="fa fa-link"></i> <span>Realtime Diagram</span></a></li>
                    <li class="active"><a href="rules.html"><i class="fa fa-link"></i> <span>Rules</span></a></li>
                    <!-- <li><a href="#"><i class="fa fa-link"></i> <span>Another Link</span></a></li> -->
                    <li class="treeview">
                        <a href="#"><i class="fa fa-link"></i> <span>More</span>
            <span class="pull-right-container">
                <i class="fa fa-angle-left pull-right"></i>
              </span>
          </a>
                        <ul class="treeview-menu">
                            <li><a href="#">Nothing</a></li>
                            <li><a href="#">Maybe later</a></li>
                        </ul>
                    </li>
                </ul>
                <!-- /.sidebar-menu -->
            </section>
            <!-- /.sidebar -->
        </aside>

        <!-- Content Wrapper. Contains page content -->
        <div class="content-wrapper">
            <!-- Content Header (Page header) -->
            <section class="content-header">
                <h1>
                    Rules management
                </h1>
                <ol class="breadcrumb">
                    <li><a href="#"><i class="fa fa-dashboard"></i> Level</a></li>
                    <li class="active">Here</li>
                </ol>
            </section>

            <!-- Main content -->
            <section class="content container-fluid">

                <!--------------------------
        | Your Page Content Here |
        -------------------------->
                <!-- active rules -->
                <div class="col-md-4">
                    <div class="box">
                        <div class="box-header with-border">
                            <h3 class="box-title">Active rules</h3>
                        </div>
                        <!-- /.box-header -->
                        <div class="box-body">
                            <ul class="list-group" id="rule-list">
                            </ul>
                        </div>
                        <!-- /.box-body -->
                    </div>
                    <!-- /.box -->
                </div>

                <!-- dic containing modals created -->
                <div id="modal-div"></div>

                <!-- add rules -->
                <div class="col-md-8">
                    <div class="box">
                        <div class="box-header with-border">
                            <h3 class="box-title">Create your rule</h3>
                        </div>
                        <!-- /.box-header -->
                        <!-- as we do not use php, we need to redo the form in javascript -->
                        <div class="box-body" id="rule-form">

                            <!-- when the form is submitted it will trigger add_new_rule(), and not refresh the page thank to the return false -->
                            <div class="row" style="padding-left:15px">
                                <form name="frm" onsubmit="add_new_rule();return false" method="post">
                                    <div class="row" id="general-field">
                                        <div class="row col-xs-12 col-md-6">
                                            <label class="col-xs-4">Rule's name</label>
                                            <input id="rule-name-input" class="col-xs-7" type="text" name="rule_name" required="true" placeholder="A name">
                                        </div>
                                    </div>
                                    <!-- setting the conditions -->
                                    <label>IF</label> <br>
                                    <fieldset id="condition-field" class="col-xs-12">
                                    </fieldset>

                                    <div class="col-md-12 text-center" id="add-bitwise-operator"></div>

                                    <!-- setting the action to take -->
                                    <label>THEN</label> <br>

                                    <fieldset id="action-field" class="col-xs-12">
                                    </fieldset>

                                    <div class="col-md-12 text-center">
                                        <span class="glyphicon glyphicon-plus" onclick="add_rule_action_form()"></span> <br>
                                    </div>

                                    <input class='btn' type="submit" value="add rule" type="button" />
                                    <button class='btn' onclick="generate_add_form()" type="button">cancel</button>
                                </form>
                            </div>

                        </div>
                        <!-- /.box-body -->
                    </div>
                    <!-- /.box -->
                </div>

            </section>
            <!-- /.content -->
        </div>
        <!-- /.content-wrapper -->

        <!-- Main Footer -->
        <footer class="main-footer">
            <!-- To the right -->
            <div class="pull-right hidden-xs">
                Anything you want
            </div>
            <!-- Default to the left -->
            <strong>Copyright &copy; 2016 <a href="#">Company</a>.</strong> All rights reserved.
        </footer>

        <!-- Control Sidebar -->
        <aside class="control-sidebar control-sidebar-dark">
            <!-- Create the tabs -->
            <ul class="nav nav-tabs nav-justified control-sidebar-tabs">
                <li class="active"><a href="#control-sidebar-home-tab" data-toggle="tab"><i class="fa fa-home"></i></a></li>
                <li><a href="#control-sidebar-settings-tab" data-toggle="tab"><i class="fa fa-gears"></i></a></li>
            </ul>
            <!-- Tab panes -->
            <div class="tab-content">
                <!-- Home tab content -->
                <div class="tab-pane active" id="control-sidebar-home-tab">


                </div>

                <!-- Stats tab content -->
                <div class="tab-pane" id="control-sidebar-stats-tab">Stats Tab Content</div>
                <!-- /.tab-pane -->
                <!-- Settings tab content -->
                <div class="tab-pane" id="control-sidebar-settings-tab">

                </div>
                <!-- /.tab-pane -->
            </div>
        </aside>
        <!-- /.control-sidebar -->
        <!-- Add the sidebar's background. This div must be placed
  immediately after the control sidebar -->
        <div class="control-sidebar-bg"></div>
    </div>
    <!-- ./wrapper -->

    <!-- REQUIRED JS SCRIPTS -->

    <!-- jQuery 3 -->
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap 3.3.7 -->
    <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <!-- AdminLTE App -->
    <script src="dist/js/adminlte.min.js"></script>
    <!-- FastClick -->
    <script src="bower_components/fastclick/lib/fastclick.js"></script>

    <!-- toogle button -->
    <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
    <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>

    <!-- AJAX needed file -->
    <script src="test/ajax.js"></script>




    <!-- Config file for this app (API server name, operator button) -->
    <script src="config/config.js"></script>


    <!-- Optionally, you can add Slimscroll and FastClick plugins.
     Both of these plugins are recommended to enhance the
     user experience. -->


    <script>
        // next 100 lines need to change #B1
        //the classes corresponding with the server
        class Rule {
            constructor(name, status) {
                this.rule_name = name;
                this.rule_status = status;
                this.rule_id = "" + Math.random().toString(36).substr(2, 9);
                this.rule_condition = {bitwise: {bitwise: [], bitwise_operator: "None", things: []}};
                this.rule_action = [];
            }

            add_rule_condition(gcondition) {
                console.log("add_rule_condition")
                console.log(gcondition)
                // this.rule_condition.bitwise.bitwise.push(gcondition);
                console.log("add_rule_condition_bitwise")
                console.log(this.rule_condition.bitwise.bitwise);
                this.rule_condition.bitwise.bitwise_operator = gcondition.bitwise_operator;
                this.rule_condition.bitwise.things = gcondition.things;
                console.log("add_rule_condition_things");
                console.log(this.rule_condition.bitwise.things);

            }

            add_action(gtimer, gaction_name, gthing_global_id, gitem_global_id, gnew_state) {
                this.rule_action.push({
                    timer: gtimer,
                    action_type: gaction_name,
                    platform_global_id: gthing_global_id,
                    item_global_id: gitem_global_id,
                    new_state: gnew_state
                });
            }
        }

        class Bitwise {
            constructor(gthing, gbitwise_operator) {
                this.things = [];
                this.things.push(gthing);
                this.bitwise_operator = gbitwise_operator;
                this.bitwise = [];
            }

            add_bitwise(gbitwise, gbitwise_operator) {
                this.bitwise.push(gbitwise);
                // this.bitwise_operator = gbitwise_operator;
            }
        }

        class Thing {
            constructor(timer, gthing_global_id, gitem_global_id, gitem_name, gitem_type, gplatform_id, goperator, gvalue) {
                this.timer = timer;
                this.thing_global_id = gthing_global_id;
                this.item_global_id = gitem_global_id;
                this.item_name = gitem_name;
                this.item_type = gitem_type;
                this.platform_id = gplatform_id;
                this.operator = goperator;
                this.value = gvalue;
            }
        }

        //First we have all the initialization
        
        // next 12 lines need to change #A1
        //we load platforms data we need from the api
        var platform_list = get_data_from_api(sensor_API + "/api/platforms");

        console.log("platform_list");
        console.log(platform_list);
        platform_list[0].things = get_data_from_api(sensor_API + "/api/things/platform_id/" + platform_list[0].platform_id + "/all/all");
        console.log(platform_list[0].things[0].items[0]);

        // then we concatenate the platform array with corresponding things and items
        for (let i = 0; i < platform_list.length; i++) {
            platform_list[i].things = get_data_from_api(sensor_API + "/api/things/platform_id/" + platform_list[i].platform_id + "/all/all");

            for (let j = 0; j < platform_list[i].things.length; j++) {
                if (platform_list[i].things[j].thing_type.localeCompare("updater") == 0) {
                    platform_list[i].things.splice(j, 1);
                }
            }
        }


        // var used to generate an id for each condition/action
        var condition_number = 0;
        var action_number = 0;
        generate_add_form(); //#C

        // the global var that contain the rules
        var rules = [];

        // this generate the rules' list and the add field on the right
        list_existing_rule();

        // definition of the functions :


        //return downloaded data from both API
        function get_data_from_api(url) {
            var request = new XMLHttpRequest();
            request.open('GET', url, false); // `false` makes the request synchronous
            request.send(null);

            if (request.readyState == 4) {
                if (request.status == 200 || request.status == 201) {
                    return JSON.parse(request.responseText);
                }
                else{
                    console.log("err get data")
                }
            }
        }

        /* list and display existing rules in left panel
         it is called a first time when the the page is loaded and whenever there is a change in the list
         It's mostly a loop that diplay the name and generate the button to act on the rules
         Also at the end of the loop it generate the modal windows for edit and details
         */
        function list_existing_rule() {
            var ruleList = document.getElementById("rule-list");
            //first we remove the old list of rules (if it exist)
            while (ruleList.firstChild) {
                ruleList.removeChild(ruleList.firstChild);
            }

            rules = get_data_from_api(rule_API + "/rule");
            for (let ruleNumber = 0; ruleNumber < rules.length; ruleNumber++) {
                //name of the rule
                let elem = document.createElement("li");
                elem.setAttribute("class", "list-group-item");
                elem.innerHTML = rules[ruleNumber].rule_name;

                //button for detail modal
                elem.appendChild(document.createElement("button"));
                elem.lastChild.setAttribute("type", "button");
                elem.lastChild.setAttribute("class", "btn btn-default btn-xs pull-right");
                elem.lastChild.setAttribute("data-toggle", "modal");
                elem.lastChild.setAttribute("data-target", "#modal-details-rule-" + ruleNumber);
                elem.lastChild.setAttribute("style", "width:24px");
                elem.lastChild.appendChild(document.createElement("i"));
                elem.lastChild.lastChild.setAttribute("class", "fa fa-info");

                //button for edit modal                
                elem.appendChild(document.createElement("button"));
                elem.lastChild.setAttribute("type", "button");
                elem.lastChild.setAttribute("class", "btn btn-default btn-xs pull-right");
                elem.lastChild.setAttribute("data-toggle", "modal");
                elem.lastChild.setAttribute("data-target", "#modal-edit-rule-" + ruleNumber);
                elem.lastChild.setAttribute("style", "margin-right: 7px; width:24px");
                elem.lastChild.appendChild(document.createElement("i"));
                elem.lastChild.lastChild.setAttribute("class", "fa fa-edit");
                elem.lastChild.onclick = function() {
                    rule_edit_display(ruleNumber);
                };
                // console.log(rules[ruleNumber])
                // this generate the modal window corresponding (first div into div)
                rule_details(ruleNumber);
                // edit doesn't work yet #F
                rule_edit_display(ruleNumber);

                ruleList.appendChild(elem);
            }
        }

        // function called when the cancel button is pressed at the end of the add rule form, it remove all added field a well as cleaning the form
        // it is also called a first time when the the page is loaded
        function generate_add_form() {
            //first we clear the name
            document.getElementById("rule-name-input").value = '';

            // we remove the condition/action/button
            while (document.getElementById("condition-field").firstChild) {
                document.getElementById("condition-field").removeChild(document.getElementById("condition-field").firstChild);
            }

            while (document.getElementById("action-field").firstChild) {
                document.getElementById("action-field").removeChild(document.getElementById("action-field").firstChild);
            }

            while (document.getElementById("add-bitwise-operator").firstChild) {
                document.getElementById("add-bitwise-operator").removeChild(document.getElementById("add-bitwise-operator").firstChild);
            }
            // we actualize the button operator (from the config files) if needed, the argument is the parent element where it is generated

            // we re-initialize the global var
            condition_number = 0;
            action_number = 0;

            // we generate one condition/action
            // the first condition field have the bitwise_operator first, which tell that it doesn't need to be displayed
            add_rule_condition_form("FIRST");
            operator_button_generator("add-bitwise-operator");
            add_rule_action_form();
        }

        
        // here is the functions used by generate add form

        /* create the operator button (AND, OR...) from the information in the config/config.js file
         it's a loop that go through the array and generate a button
         for now it's only adapted for the add form #F
         */
        function operator_button_generator(parent_id) {
            for (let elem of operator_button_list) {
                let content = document.createElement("button");


                document.getElementById(parent_id).appendChild(content);

                content.setAttribute("type", "button");
                content.onclick = function() {
                    // this is why this function work only for the add form, please refer to the comments of the function #F
                    add_rule_condition_form(elem);
                }
                content.classList.add("btn");
                content.classList.add("btn-sm");
                content.innerHTML = elem;
                content.style.margin = "2px";
            }
        }
        

        function edit_operator_button_generator(ruleNumber, parent_id) {
            for (let elem of operator_button_list) {
                let content = document.createElement("button");


                document.getElementById(parent_id).appendChild(content);

                content.setAttribute("type", "button");
                content.onclick = function() {
                    add_edit_rule_condition_form(ruleNumber, elem);
                }
                content.classList.add("btn");
                content.classList.add("btn-sm");
                content.innerHTML = elem;
                content.style.margin = "2px";
            }
        }
        
        
        // this function works specificaly to generate a condition line in the ADD form
        // it is needed as long as the condition_number need to change for the id
        function add_rule_condition_form(bitwise_operator) {
            add_condition_field("condition-field", "add", condition_number, bitwise_operator);
            condition_number++;
        }

        function add_edit_rule_condition_form(ruleNumber, bitwise_operator) {
            add_condition_field("edit-condition-field-" + ruleNumber, "edit", condition_number, bitwise_operator);
            condition_number++;
        }


        function add_condition_field_reverst_child(parent_id, tpye, suffix_id, oper) {
            //we set the container (it so that every condition is in a different container, with a different id)
            let content = document.createElement("div");
            document.getElementById(parent_id).insertBefore(content, document.getElementById(parent_id).firstChild);
            content.className = "row col-xs-12";
            content.setAttribute("id", tpye + "-condition-" + suffix_id);
            content.setAttribute("style", "margin-bottom: 7px");

            //if it isn't the first condition, we put the bitwise_operator
            if (oper.localeCompare("FIRST") != 0 && oper.localeCompare("None") != 0) {
                content.appendChild(document.createElement("div"));
                content.lastChild.className = "col-xs-12";
                content.lastChild.appendChild(document.createElement("p"));
                content.lastChild.lastChild.innerHTML = oper;
                content.lastChild.lastChild.style.marginLeft = "-19px";
                if (oper.localeCompare("AND") == 0) {
                    content.lastChild.lastChild.style.marginTop = "-7px";
                    content.lastChild.lastChild.style.marginBottom = "0px";
                }
            }

            // we first choose a timer
            // it's a HTML input element, with the 'time' type
            content.appendChild(document.createElement("input"));
            content.lastChild.setAttribute("type", "text");
            content.lastChild.setAttribute("class", "col-xs-2");
            content.lastChild.style.paddingRight = "0px";
            content.lastChild.setAttribute("id", tpye + "-condition-timer-" + suffix_id);
            content.lastChild.setAttribute("value", "00s");
            content.lastChild.setAttribute("step", "1");
            content.lastChild.setAttribute("title", "The minimum time the condition has to stay active");


            // platform select
            var selection = document.createElement("select");
            content.appendChild(selection);
            selection.setAttribute("name", tpye + "-plateform-" + suffix_id);
            selection.className += " col-xs-3";

            // we generate the choice from the global 'platform_list' var #A
            for (let i = 0; i < platform_list.length; i++) {
                selection.appendChild(document.createElement("option"));
                selection.lastChild.setAttribute("value", i);
                selection.lastChild.innerHTML =  platform_list[i].platform_name + '-' + platform_list[i].platform_id;
            }

            selection.firstChild.setAttribute("selected", "selected");

            // we generate a select for the sensor
            content.appendChild(document.createElement("select"));
            content.lastChild.setAttribute("name", tpye + "-item-" + suffix_id);
            content.lastChild.setAttribute("id", tpye + "-field-item-" + suffix_id);
            content.lastChild.className += " col-xs-2";

            // here we fill the option for the sensor's selector with the items from the selected platform
            // as the last fields of the condition depend on this choice, it is generated inside this function
            sensor_of_plateform_option(0, tpye + "-field-item-" + suffix_id, tpye);



            // when we select a platform it changes the items we can choose
            selection.onchange = function() {
                sensor_of_plateform_option(selection.selectedIndex, tpye + "-field-item-" + suffix_id, tpye);
            }
            

            //the button to remove this line
            content.appendChild(document.createElement("button"));
            content.lastChild.setAttribute("type", "button");
            content.lastChild.setAttribute("class", "btn btn-default btn-xs pull-right col-xs-1");
            content.lastChild.setAttribute("style", "width: 24px");
            content.lastChild.onclick = function() {
                remove_field(tpye + "-condition-" + suffix_id);
            }
            content.lastChild.appendChild(document.createElement("i"));
            content.lastChild.lastChild.setAttribute("class", "fa fa-remove");

            return content;
        }

        
        /* this is the global function that generate a condition line, it works for the add and edit forms as it generate default data
            parent_id is the DOM element containing the line
            tpye is 'add' or 'edit', so two fields in different forms aren't confused
            suffix_id is what differentiate a line form another
                for add it's generated from the global var 'condition_number'
                for edit it's the number of the rule in rules[] - the condition number, example '2-1'
            oper is the bitwise operator, it's how it is link to the other conditions
                it's 'FIRST' for the first condition, it mean it isn't displayed, and it isn't used for the validation of the rule
                in other cases, when we click a button it's the label of the button
        */
        function add_condition_field(parent_id, tpye, suffix_id, oper) {
            //we set the container (it so that every condition is in a different container, with a different id)
            let content = document.createElement("div");
            document.getElementById(parent_id).appendChild(content);
            content.className = "row col-xs-12";
            content.setAttribute("id", tpye + "-condition-" + suffix_id);
            content.setAttribute("style", "margin-bottom: 7px");

            //if it isn't the first condition, we put the bitwise_operator
            if (oper.localeCompare("FIRST") != 0 && oper.localeCompare("None") != 0) {
                content.appendChild(document.createElement("div"));
                content.lastChild.className = "col-xs-12";
                content.lastChild.appendChild(document.createElement("p"));
                content.lastChild.lastChild.innerHTML = oper;
                content.lastChild.lastChild.style.marginLeft = "-19px";
                if (oper.localeCompare("AND") == 0) {
                    content.lastChild.lastChild.style.marginTop = "-7px";
                    content.lastChild.lastChild.style.marginBottom = "0px";
                }
            }

            // we first choose a timer
            // it's a HTML input element, with the 'time' type
            content.appendChild(document.createElement("input"));
            content.lastChild.setAttribute("type", "text");
            content.lastChild.setAttribute("class", "col-xs-2");
            content.lastChild.style.paddingRight = "0px";
            content.lastChild.setAttribute("id", tpye + "-condition-timer-" + suffix_id);
            content.lastChild.setAttribute("value", "00s");
            content.lastChild.setAttribute("step", "1");
            content.lastChild.setAttribute("title", "The minimum time the condition has to stay active");


            // platform select
            var selection = document.createElement("select");
            content.appendChild(selection);
            selection.setAttribute("name", tpye + "-plateform-" + suffix_id);
            selection.className += " col-xs-3";

            // we generate the choice from the global 'platform_list' var #A
            for (let i = 0; i < platform_list.length; i++) {
                selection.appendChild(document.createElement("option"));
                selection.lastChild.setAttribute("value", i);
                selection.lastChild.innerHTML =  platform_list[i].platform_name + '-' + platform_list[i].platform_id;
            }

            selection.firstChild.setAttribute("selected", "selected");

            // we generate a select for the sensor
            content.appendChild(document.createElement("select"));
            content.lastChild.setAttribute("name", tpye + "-item-" + suffix_id);
            content.lastChild.setAttribute("id", tpye + "-field-item-" + suffix_id);
            content.lastChild.className += " col-xs-2";

            // here we fill the option for the sensor's selector with the items from the selected platform
            // as the last fields of the condition depend on this choice, it is generated inside this function
            sensor_of_plateform_option(0, tpye + "-field-item-" + suffix_id, tpye);



            // when we select a platform it changes the items we can choose
            selection.onchange = function() {
                sensor_of_plateform_option(selection.selectedIndex, tpye + "-field-item-" + suffix_id, tpye);
            }
            

            //the button to remove this line
            content.appendChild(document.createElement("button"));
            content.lastChild.setAttribute("type", "button");
            content.lastChild.setAttribute("class", "btn btn-default btn-xs pull-right col-xs-1");
            content.lastChild.setAttribute("style", "width: 24px");
            content.lastChild.onclick = function() {
                remove_field(tpye + "-condition-" + suffix_id);
            }
            content.lastChild.appendChild(document.createElement("i"));
            content.lastChild.lastChild.setAttribute("class", "fa fa-remove");

            return content;
        }

        /* 
        put the things from the plateform given in the parameters as option of the select which id is given, the tpye define if it's add or edit for the value field id
        also call the function that take care of the operator and the value
        */
        function sensor_of_plateform_option(platform_index, select_id, tpye) {
            let things = platform_list[platform_index].things;
            let selec = document.getElementById(select_id);

            // console.log("things")
            // console.log(things)

            //first we get rid of existing options in this select
            while (selec.firstChild) {
                selec.removeChild(selec.firstChild);
            }

            //then we add the new one
            for (let i = 0; i < things.length; i++) {
                for (let j = 0; j < things[i].items.length; j++) {
                    selec.appendChild(document.createElement("option"));

                    // the value is the thing index - item index from platform_list #A
                    selec.lastChild.setAttribute("value", i + "-" + j);
                    selec.lastChild.innerHTML = things[i].items[j].item_name;
                }
            }

            // when we click on one the option it change the operator and value input
            selec.onchange = function() {
                // we get the item type
                let thing_item = selec.options[selec.selectedIndex].value.split("-"); // this is the thing and item index from platform_list #A
                let item_type = things[thing_item[0]].items[thing_item[1]].item_type;
                
                // we get the suffix of the id of this condition
                let line_id = selec.getAttribute("id").slice(tpye.length + "-field-item-".length, selec.getAttribute("id").length);
                
                
                adaptative_value_input(item_type, selec.parentElement, line_id, tpye);
            }
            //we modify the value input so it match the first sensor displayed
            adaptative_value_input(things[0].items[0].item_type, selec.parentElement, condition_number, tpye);
        }
        
        /* change the operator value input according to the sensor :
            - humidity/temprature input with type="number"
            - binary_sensor/light dropdown (limited chocie)
            
            line_id is the line number (at the end of the name)
            tpye is to know if it's add or edit for the name
        */
        function adaptative_value_input(item_type, parent, line_id, tpye) {
            let operator_field, value_field, operator_field_index, value_field_index;

            //in the case we are in the first line, the index changes because of the absence of bitwise operator
            if (parent.childElementCount == 6) {
                operator_field_index = 3;
                value_field_index = 4;
            } else {
                operator_field_index = 4;
                value_field_index = 5;

            }

            switch (item_type) {
                case "binary_sensor":
                case "light":
                case "Switch":
                    
                    // as the chocie is limited, the operator is '=='
                    operator_field = document.createElement("p");
                    operator_field.setAttribute("name", "comparison-type-" + line_id);
                    operator_field.setAttribute("style", "text-align: center");
                    operator_field.className += " col-xs-2";
                    operator_field.innerHTML += "==";

                    if (parent.childNodes[4]) {
                        parent.replaceChild(operator_field, parent.childNodes[operator_field_index]);
                    } else {
                        parent.appendChild(operator_field);
                    }

                    value_field = document.createElement("select");
                    value_field.setAttribute("name", tpye + "-value-" + action_number);
                    value_field.className += " col-xs-2";

                    value_field.appendChild(document.createElement("option"));
                    value_field.lastChild.setAttribute("value", "0");
                    value_field.lastChild.innerHTML = "off";
                    value_field.appendChild(document.createElement("option"));
                    value_field.lastChild.setAttribute("value", "1");
                    value_field.lastChild.innerHTML = "on";

                    if (parent.childNodes[5]) {
                        parent.replaceChild(value_field, parent.childNodes[value_field_index]);;
                    } else {
                        parent.appendChild(value_field);
                    }
                    break;
                case "sensor":
                    //we set the dropdown of operator
                    operator_field = document.createElement("select");
                    operator_field.setAttribute("name", "comparison-type-" + line_id);
                    operator_field.className += " col-xs-2";

                    // #B because the values have  changed, also it can be put in the config file
                    operator_field.appendChild(document.createElement("option"));
                    operator_field.lastChild.setAttribute("value", "GT");
                    operator_field.lastChild.innerHTML = ">";
                    operator_field.appendChild(document.createElement("option"));
                    operator_field.lastChild.setAttribute("value", "LT");
                    operator_field.lastChild.innerHTML = "<";
                    operator_field.appendChild(document.createElement("option"));
                    operator_field.lastChild.setAttribute("value", "GE");
                    operator_field.lastChild.innerHTML = ">=";
                    operator_field.appendChild(document.createElement("option"));
                    operator_field.lastChild.setAttribute("value", "LE");
                    operator_field.lastChild.innerHTML = "<=";
                    operator_field.appendChild(document.createElement("option"));
                    operator_field.lastChild.setAttribute("value", "EQ");
                    operator_field.lastChild.innerHTML = "==";
                    operator_field.appendChild(document.createElement("option"));
                    operator_field.lastChild.setAttribute("value", "NE");
                    operator_field.lastChild.innerHTML = "<>";



                    if (parent.childNodes[4]) {
                        parent.replaceChild(operator_field, parent.childNodes[operator_field_index]);
                    } else {
                        parent.appendChild(operator_field);
                    }

                    //we set the value field
                    value_field = document.createElement("input");
                    value_field.setAttribute("type", "string");
                    value_field.setAttribute("name", "value-" + line_id);
                    value_field.setAttribute("required", "true");
                    value_field.setAttribute("step", "1");
                    value_field.value = 0;
                    value_field.className += " col-xs-2";

                    if (parent.childNodes[5]) {
                        parent.replaceChild(value_field, parent.childNodes[value_field_index]);
                    } else {
                        parent.appendChild(value_field);
                    }
                    break;
                default:
                    console.error("this sensor isn't managed yet : " + item_type);
            }
        }
        
        
        
        //this function remove a condition/action with an id == field_id
        function remove_field(field_id) {
            let elem = document.getElementById(field_id);
            let parent = elem.parentElement;
            parent.removeChild(elem);

            // if it was the only action/condition, we generate a new one
            if (parent.childNodes.length == 0) {
                if (parent.getAttribute("id").split("-")[0].localeCompare("condition") == 0) {
                    add_rule_condition_form("FIRST");
                } else {
                    add_rule_action_form();
                }
            }

        }
        
        
        
        // this function works specificaly to generate an action line in the ADD form
        // it is needed as long as the action_number need to change for the id
        function add_rule_action_form() {
            add_action_field("action-field", "add", action_number);
            action_number++;
        }
          
        /* this is the global function that generate an action line, it works for the add and edit forms as it generate default data
            parent_id is the DOM element containing the line
            tpye is 'add' or 'edit', so two fields in different forms aren't confused
            suffix_id is what differentiate a line form another
                for add it's generated from the global var '    action_number'
                for edit it's the number of the rule in rules[] - the action number, example '2-1'
        */
        function add_action_field(parent_id, tpye, suffix_id) {
            //we first set the container
            let content = document.createElement("div");
            document.getElementById(parent_id).appendChild(content);

            content.className = "row col-xs-12";
            content.setAttribute("id", tpye + "-action-" + suffix_id);
            content.setAttribute("style", "margin-bottom: 7px");

            //we choose a timer ? same as in the condtion
            content.appendChild(document.createElement("input"));
            content.lastChild.setAttribute("type", "text");
            content.lastChild.setAttribute("class", "col-xs-2");
            content.lastChild.style.paddingRight = "0px";
            content.lastChild.setAttribute("id", tpye + "-action-timer-" + suffix_id);
            content.lastChild.setAttribute("value", "00s");
            content.lastChild.setAttribute("step", "1");
            content.lastChild.setAttribute("title", "The time the action will activate after the condtions are met");

            //we set the dropdown to chose an action
            var selection1 = document.createElement("select");
            content.appendChild(selection1);
            selection1.setAttribute("name", tpye + "-action-type-" + suffix_id);

            for (let i = 0; i < action_list.length; i++) {
                selection1.appendChild(document.createElement("option"));
                selection1.lastChild.setAttribute("value", action_list[i]);
                selection1.lastChild.innerHTML = action_list[i];
            }

            var selection2 = document.createElement("select");
            content.appendChild(selection2);
            selection2.setAttribute("name", tpye + "-platform-" + suffix_id);
            selection2.className += " col-xs-2";


            for (let i = 0; i < platform_list.length; i++) {
                selection2.appendChild(document.createElement("option"));
                selection2.lastChild.setAttribute("value", i);
                selection2.lastChild.innerHTML = platform_list[i].platform_name + '-' + platform_list[i].platform_id;
            }

            selection2.firstChild.setAttribute("selected", "selected");

            // we generate a select for the sensor
            content.appendChild(document.createElement("select"));
            content.lastChild.setAttribute("name", tpye + "-item-" + suffix_id);
            content.lastChild.setAttribute("id", tpye + "-field-item-action-" + suffix_id);
            content.lastChild.className += " col-xs-2";

            // here we fill the option for the sensor's selector with the items from the selected platform
            // as the last fields of the condition depend on this choice, it is generated inside this function

            sensor_of_plateform_option(0, tpye + "-field-item-action-" + suffix_id, tpye);



            // when we select a platform it changes the items we can choose
            selection2.onchange = function() {
                sensor_of_plateform_option(selection2.selectedIndex, tpye + "-field-item-action-" + suffix_id, tpye);
            }
            

            // //the button to remove this line
            content.appendChild(document.createElement("button"));
            content.lastChild.setAttribute("type", "button");
            content.lastChild.setAttribute("class", "btn btn-default btn-xs pull-right col-xs-1");
            content.lastChild.setAttribute("style", "width: 24px");
            content.lastChild.onclick = function() {
                remove_field(tpye + "-action-" + suffix_id);
            }
            content.lastChild.appendChild(document.createElement("i"));
            content.lastChild.lastChild.setAttribute("class", "fa fa-remove");

            /*
            // chose platform_list
            for(let i = 0; i < platform_list.length; i++) {
                // selection2.appendChild(document.createElement("option"));
                // selection2.lastChild.setAttribute("value", platform_list[i].things[j].thing_global_id);
                // selection2.lastChild.innerHTML =  platform_list[i].things[j].thing_global_id;
                for(let j = 0; j < platform_list[i].things.length; j++) {
                    for(let k = 0; k < platform_list[i].things[j].items.length; k++) {
                        if(platform_list[i].things[j].items[k].can_set_state == "yes") {
                            selection2.appendChild(document.createElement("option"));
                            selection2.lastChild.setAttribute("value", platform_list[i].things[j].thing_global_id);
                            selection2.lastChild.innerHTML =  platform_list[i].things[j].thing_global_id;

                            // selection3.appendChild(document.createElement("option"));
                            // selection3.lastChild.setAttribute("value", platform_list[i].things[j].items[k].item_global_id);
                            // selection3.lastChild.innerHTML =  platform_list[i].things[j].items[k].item_global_id;
                        }
                    }
                }
            }
            */





            // // the button to remove the line
            // content.appendChild(document.createElement("button"));
            // content.lastChild.setAttribute("type", "button");
            // content.lastChild.setAttribute("class", "btn btn-default btn-xs pull-right col-xs-1");
            // content.lastChild.setAttribute("id", "dismiss-action-field-" + action_number);
            // content.lastChild.setAttribute("style", "width: 24px");
            // content.lastChild.onclick = function() {
            //     remove_field(content.getAttribute("id"));
            // }
            // content.lastChild.appendChild(document.createElement("i"));
            // content.lastChild.lastChild.setAttribute("class", "fa fa-remove");

            return content;
        }       
        
        // this function is called when the add button is clicked
        // it's this function that gather all the data from the form to make a rule and send it to the server
        function add_new_rule() {
            let myRule = new Rule(document.getElementById("rule-name-input").value, "enable");
            console.log("aaaaaaaaaaa");
            console.log(myRule);
            // in this loop we add the condition to do in the rule we create
            // each loop it goes take the DOM elements -> make some operation if needed -> we take the correct data -> we put it in structure

            let bitwise;
           
            for (let i = 0; i < document.getElementById("condition-field").childNodes.length; i++) {
                // we get the first element, it depend if the condition is the first because of the bitwise operator
                // console.log("condition-field");
                // console.log(i);
                let timer, bitwise_operator;
                console.log("tagName")
                console.log(document.getElementById("condition-field").childNodes[i].firstChild.tagName);

                if (document.getElementById("condition-field").childNodes[i].firstChild.tagName.localeCompare("INPUT") == 0) {
                    bitwise_operator = "None";
                    timer = document.getElementById("condition-field").childNodes[i].firstChild;
                    console.log(timer);
                }
                else {
                    bitwise_operator = document.getElementById("condition-field").childNodes[i].firstChild;
                    console.log(bitwise_operator);
                    timer = bitwise_operator.nextSibling;
                    console.log(timer);
                    bitwise_operator = bitwise_operator.firstChild.innerHTML;
                    console.log(bitwise_operator);
                }


                // we get the platform element
                let platform = timer.nextSibling;
                console.log("platform_1");
                console.log(platform);

                //then the thing-item element (the sensor)
                let thing_item = platform.nextSibling;
                console.log("thing_item");
                console.log(thing_item);
                console.log(platform_list[thing_item.value.split("-")[1]].platform_id);

                //then the operator element
                let operator = thing_item.nextSibling;
                console.log("operator");
                console.log(operator);

                //finally the value element to compare
                let value = operator.nextSibling;

                //then we extract the intermediate data
                platform = platform.value;
                console.log("platform");
                console.log(platform);

                thing_item = thing_item.value.split("-"); // chi so things + chi so item
                console.log("thing_item");
                console.log(thing_item);


                console.log("operator.tagName");
                console.log(operator.tagName)

                //if it's in an html <p> tag, the operator is '=='
                if (operator.tagName.localeCompare("P") == 0) { // may have a bug, change not tested (localCompare)
                    operator = "EQ"; // #B
                    console.log("operator")
                    console.log(operator);
                } else if (operator.tagName.localeCompare("SELECT") == 0) {
                    operator = operator.options[operator.selectedIndex].value;
                    console.log(operator);
                }

                console.log("value.tagName ")
                console.log(value.tagName )

                if (value.tagName.localeCompare("INPUT") == 0) { // may have a bug, change not tested (localCompare)
                    value = value.value;
                    console.log(value);
                } else if (value.tagName.localeCompare("SELECT") == 0) {
                    value = value.options[value.selectedIndex].value;
                    console.log(value);
                }

                // then we have the correct data 
                // #C1 the following lines need to change according to the new rule data structure
                let theItem = platform_list[platform].things[thing_item[0]].items[thing_item[1]];
                console.log("theItem")
                console.log(theItem);

                let theThing = platform_list[platform].things[thing_item[0]];
                console.log("theThing");
                console.log(theThing);

                let aThing = new Thing(timer.value, theThing.thing_global_id, theItem.item_global_id, theItem.item_name, theItem.item_type, theThing.platform_id, operator, value);
                console.log("aThing");
                console.log(aThing);


                // console.log(new Bitwise(aThing, bitwise_operator));
                console.log("new Bitwise(aThing, bitwise_operator)");

                if (bitwise_operator.localeCompare("None") == 0) {
                    // console.log("add_rule_condition");
                    myRule.add_rule_condition(new Bitwise(aThing, bitwise_operator));
                } else {
                    add_a_bitwise(myRule.rule_condition.bitwise, new Bitwise(aThing, bitwise_operator), bitwise_operator);
                    console.log("add_a_bitwise")
                }


                console.log("myRule");
                console.log(myRule);
            }

            console.log("length");
            console.log(document.getElementById("action-field").childNodes.length);

            // Here we add the actions to do in the rule we create
            for (let i = 0; i < document.getElementById("action-field").childNodes.length; i++) {
                // console.log(document.getElementById("action-field").childNodes[i]);
                let timer = document.getElementById("action-field").childNodes[i].firstChild;

                let select = timer.nextElementSibling;
                console.log("next timer")
                console.log(select.options[select.selectedIndex].value);

                let thing_global_id = select.nextElementSibling;
                // console.log(thing_global_id.options[thing_global_id.selectedIndex].value);
                // console.log("item_global_id");
                let item_global_id = thing_global_id.nextElementSibling;
                // let item_global_id_index = platform_list[platform].things[thing_item[0]].items[thing_item[1]];
                // console.log("item_global_id");

                // console.log(item_index);
                // console.log(platform_index);

                // console.log(platform_list[platform_index].things[item_index][0].item_global_id);

                let value = item_global_id.nextElementSibling.nextElementSibling;
                // console.log(value.options[value.selectedIndex].value);
                // #C
                myRule.add_action(timer.value, select.options[select.selectedIndex].value, thing_global_id.options[thing_global_id.selectedIndex].innerHTML, item_global_id.options[item_global_id.selectedIndex].innerHTML, value.options[value.selectedIndex].value);
            }

            // console.log(myRule);

            // console.log(typeof myRule);


            push_rule(myRule); //#C
            list_existing_rule();
            generate_add_form();
        }       
        
        //this should add a bitwise in the last bitwise (identified by the bitwise_operator 'None')
        function add_a_bitwise(bitwise_parent, bitwise_child, ope) {
            console.log("add_a_bitwise")
            console.log(bitwise_parent)
            console.log(bitwise_child)

            if (bitwise_parent.bitwise.length == 0){
                // bitwise_parent.add_bitwise(bitwise_child, ope);
                bitwise_parent.bitwise.push(bitwise_child)
            }
            else{
                add_a_bitwise(bitwise_parent.bitwise[0], bitwise_child, ope)
            }

            // if (bitwise_parent.bitwise_operator.localeCompare("None") == 0) {
            //     bitwise_parent.add_bitwise(bitwise_child, ope);
            // } else {
            //     add_a_bitwise(bitwise_parent.bitwise[0], bitwise_child, ope);
            // }
        }

        //the function that push a rule on the server
        function push_rule(rule) {
            console.log("push_rule")
            var xhr = new XMLHttpRequest();
            var url = rule_API + "/rule";
            xhr.open("POST", url, false);
            xhr.setRequestHeader("Content-Type", "application/json; charset=utf-8");
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var json = JSON.parse(xhr.responseText);
                    console.log("json");
                    console.log(json);
                }
                else{
                    console.log("error push rule");
                }
            };
            var data = JSON.stringify(rule);
            xhr.send(data);
        }

        // function which manage the display when the "i" button is clicked
        function rule_details(ruleNumber) {
            //first we look if this modal window already exist
            if (document.getElementById("modal-details-rule-" + ruleNumber)) {
                document.getElementById("modal-details-rule-" + ruleNumber).parentNode.removeChild(document.getElementById("modal-details-rule-" + ruleNumber));
            }

            let modalDiv = document.getElementById("modal-div");
            modalDiv.appendChild(document.createElement("div"));
            modalDiv.lastChild.setAttribute("class", "modal fade");
            modalDiv.lastChild.setAttribute("id", "modal-details-rule-" + ruleNumber);

            modalDiv.lastChild.appendChild(document.createElement("div"));
            modalDiv.lastChild.lastChild.setAttribute("class", "modal-dialog");

            //the content of the modal window
            modalDiv.lastChild.lastChild.appendChild(document.createElement("div"));
            let modalContent = modalDiv.lastChild.lastChild.lastChild;
            modalContent.setAttribute("class", "modal-content");

            //content of the header
            modalContent.appendChild(document.createElement("div"));
            modalContent.lastChild.setAttribute("class", "modal-header");

            modalContent.lastChild.appendChild(document.createElement("button"));
            modalContent.lastChild.lastChild.setAttribute("type", "button");
            modalContent.lastChild.lastChild.setAttribute("class", "close");
            modalContent.lastChild.lastChild.setAttribute("data-dismiss", "modal");
            modalContent.lastChild.lastChild.setAttribute("aria-label", "Close");
            modalContent.lastChild.lastChild.appendChild(document.createElement("span"));
            modalContent.lastChild.lastChild.lastChild.setAttribute("aria-hidden", "true");
            modalContent.lastChild.lastChild.lastChild.innerHTML = '&times;';

            modalContent.lastChild.appendChild(document.createElement("h4"));
            modalContent.lastChild.lastChild.setAttribute("class", "modal-title");
            modalContent.lastChild.lastChild.innerHTML += rules[ruleNumber].rule_name;
            
            //content of the body
            modalContent.appendChild(document.createElement("div"));
            let modalBody = modalContent.lastChild;
            modalBody.setAttribute("class", "modal-body");


            modalBody.appendChild(document.createElement("p"));
            modalBody.lastChild.innerHTML = "> rule_id: " + rules[ruleNumber].rule_id;
            modalBody.lastChild.style.color = "#777777";
            modalBody.lastChild.style.marginTop = "-12px";
            modalBody.lastChild.style.fontSize = "7";


            modalBody.appendChild(document.createElement("h5"));
            modalBody.lastChild.innerHTML = "IF";
            modalBody.innerHTML += "(";
            modalBody.appendChild(document.createElement("br"));
            modalBody.innerHTML += "\"bitwise\": {";
            modalBody.appendChild(document.createElement("br"));
            modalBody.innerHTML += "\"bitwise\": {";
            modalBody.appendChild(document.createElement("br"));
            modalBody.appendChild(document.createElement("br"));
            // We go through the bitwise
            for(let i = 0; i < rules[ruleNumber].rule_condition.bitwise.bitwise.length; i++) {
                modalBody.appendChild(document.createElement("div"));
                bitwise_detail(modalBody.lastChild, rules[ruleNumber].rule_condition.bitwise.bitwise[i]);
            }
            modalBody.innerHTML += "\t}";
            modalBody.appendChild(document.createElement("br"));
            modalBody.innerHTML += "}";
            modalBody.appendChild(document.createElement("br"));
            modalBody.innerHTML += "bitwise_operator: \"" + rules[ruleNumber].rule_condition.bitwise.bitwise_operator + "\"";
            modalBody.appendChild(document.createElement("br"));
            modalBody.innerHTML += "things: \"" + JSON.stringify(rules[ruleNumber].rule_condition.bitwise.things, undefined, 4) + "\"";
            modalBody.appendChild(document.createElement("br"));
            modalBody.innerHTML += ")";
            
            // bitwise_detail(modalBody.lastChild, rules[ruleNumber].rule_condition.bitwise)

            modalBody.appendChild(document.createElement("h5"));
            modalBody.lastChild.innerHTML = "THEN";
            // // #D
            modalBody.innerHTML += "(";
            for (let i = 0; i < rules[ruleNumber].rule_action.length; i++) {
                let acti = JSON.stringify(rules[ruleNumber].rule_action[i], undefined, 4);
                modalBody.appendChild(document.createElement("p"));
                modalBody.lastChild.innerHTML += acti;
            }
            modalBody.innerHTML += ")";


            //content of the modal footer
            modalContent.appendChild(document.createElement("div"));
            modalContent.lastChild.setAttribute("class", "modal-footer");
            modalContent.lastChild.appendChild(document.createElement("button"));
            modalContent.lastChild.lastChild.setAttribute("type", "button");
            modalContent.lastChild.lastChild.setAttribute("class", "btn btn-default pull-right");
            modalContent.lastChild.lastChild.setAttribute("data-dismiss", "modal");
            modalContent.lastChild.lastChild.innerHTML = "Close";
        }

        // this display a bitwise (~condition) and call in recursion this function to display the bitwise inside
        // #D
        function bitwise_detail(parent_element, bitwise) {
            // console.log(bitwise)
            let container = parent_element.appendChild(document.createElement("div"));
            container.style.paddingLeft = "12px";
            let content = container.appendChild(document.createElement("p"));
            content.style.marginTop = "-10px";

            //the timer
            content.innerHTML += JSON.stringify(bitwise, undefined, 4);
            if (bitwise.bitwise_operator.localeCompare("None") != 0) {
                for (let k = 0; k < bitwise.bitwise.length; k++) {
                    content.appendChild(document.createElement("br"));
                    content.appendChild(document.createElement("p"));
                    content.lastChild.innerHTML += bitwise.bitwise_operator;
                    bitwise_detail(container, bitwise.bitwise[k]);
                }
            }
            container.appendChild(document.createElement("p"));
            container.lastChild.style.marginTop = "-10px";
        }
        
    
        // function which manage the display when the edit (the pen) button is clicked
        // #E
        function rule_edit_display(ruleNumber) {
            // console.log("rule_edit_display")
            //first we look if this modal window already exist
            if (document.getElementById("modal-edit-rule-" + ruleNumber)) {
                document.getElementById("modal-edit-rule-" + ruleNumber).parentNode.removeChild(document.getElementById("modal-edit-rule-" + ruleNumber));
            }

            //here we got the rule
            var aRule = rules[ruleNumber];
            // console.log(aRule)
            //the declaration of the modal window
            let modalDiv = document.getElementById("modal-div");
            modalDiv.appendChild(document.createElement("div"));
            modalDiv.lastChild.setAttribute("class", "modal fade");
            modalDiv.lastChild.setAttribute("id", "modal-edit-rule-" + ruleNumber);

            modalDiv.lastChild.appendChild(document.createElement("div"));
            modalDiv.lastChild.lastChild.setAttribute("class", "modal-dialog");
            modalDiv.lastChild.lastChild.setAttribute("style", "width: 50%");

            modalDiv.lastChild.lastChild.appendChild(document.createElement("div"));
            let modalContent = modalDiv.lastChild.lastChild.lastChild;
            modalContent.setAttribute("class", "modal-content");

            //content of the header
            modalContent.appendChild(document.createElement("div"));
            modalContent.lastChild.setAttribute("class", "modal-header");


            modalContent.lastChild.appendChild(document.createElement("button"));
            modalContent.lastChild.lastChild.setAttribute("type", "button");
            modalContent.lastChild.lastChild.setAttribute("class", "close");
            modalContent.lastChild.lastChild.setAttribute("data-dismiss", "modal");
            modalContent.lastChild.lastChild.setAttribute("aria-label", "Close");
            modalContent.lastChild.lastChild.appendChild(document.createElement("span"));
            modalContent.lastChild.lastChild.lastChild.setAttribute("aria-hidden", "true");
            modalContent.lastChild.lastChild.lastChild.innerHTML = '&times;';

            //the rule name
            modalContent.lastChild.appendChild(document.createElement("input"));
            modalContent.lastChild.lastChild.setAttribute("type", "text");
            modalContent.lastChild.lastChild.setAttribute("name", "rule-" + ruleNumber);
            modalContent.lastChild.lastChild.setAttribute("required", "true");
            modalContent.lastChild.lastChild.value = aRule.rule_name;


            // modalContent.lastChild.appendChild(document.createElement("p"));
            // modalContent.lastChild.lastChild.innerHTML = "rule_id: " + rules[ruleNumber].rule_id;
            // modalContent.lastChild.lastChild.style.color = "#777777";
            // modalContent.lastChild.lastChild.style.marginTop = "0px";
            // modalContent.lastChild.lastChild.style.fontSize = "7";


            //content of the body
            modalContent.appendChild(document.createElement("div"));
            let modalBody = modalContent.lastChild;
            modalBody.setAttribute("class", "modal-body");



            modalBody.appendChild(document.createElement("h5"));
            modalBody.lastChild.innerHTML = "IF";

            modalBody.appendChild(document.createElement("fieldset"));
            modalBody.lastChild.setAttribute("id", "edit-condition-field-" + ruleNumber);



            //////////////////// TEST DISPLAY RULE CONDITION ///////////////////
            // while (aRule.rule_condition.bitwise.length != 0)

            // console.log("bitwise");
            let bitwise = aRule.rule_condition.bitwise.bitwise;
            let bitwise_operator = aRule.rule_condition.bitwise.bitwise_operator;
            let things = aRule.rule_condition.bitwise.things;
            // console.log("platform_list");
            // console.log(platform_list);

            let condition_count = -1;

            //here we do the conditions field
            // for (let i = 0; i < aRule.rule_condition.bitwise.bitwise.length; i++) {
            while (bitwise.length >= 0){
                // console.log("bitwise");
                // console.log(bitwise.length)
                // console.log(bitwise_operator)
                // console.log(things)

                // let condi = aRule.rule_condition.bitwise.bitwise[0];
                // console.log("condi.bitwise_operator")
                // console.log(condi.bitwise_operator)

                //first the field is generated
                let content = add_condition_field("edit-condition-field-" + ruleNumber, "edit", ruleNumber + '-' + condition_count,                                             bitwise_operator);
                // console.log("childNodes[0]")
                // console.log(content.childNodes[0])
                // console.log("item_global_id")
                // console.log(things[0].item_global_id)
                document.getElementById("edit-condition-timer-" + ruleNumber + '-' + condition_count).setAttribute("value", things[0].timer)
                // document.getElementById("edit-plateform-" + condition_count).setAttribute("value", things[0].platform_id)

                let platform_index = -1;
                // console.log(document.getElementsByName("edit-plateform-" + ruleNumber + '-' + condition_count)[0])
                for (let i=0; i<document.getElementsByName("edit-plateform-" + ruleNumber + '-' + condition_count)[0].length; i++){
                    if (document.getElementsByName("edit-plateform-" + ruleNumber + '-' + condition_count)[0][i].innerHTML.includes(things[0].platform_id) == true){
                        platform_index = document.getElementsByName("edit-plateform-" + ruleNumber + '-' + condition_count)[0][i].value;
                        break;
                    }
                }

                document.getElementsByName("edit-plateform-" + ruleNumber + '-' + condition_count)[0].value = platform_index;

                // console.log("platform_index");
                // console.log(platform_index)



                let item_index = "";

                for (let i=0; i<document.getElementById("edit-field-item-" + ruleNumber + '-' + condition_count).length; i++){
                    if (document.getElementById("edit-field-item-" + ruleNumber + '-' + condition_count)[i].innerHTML.localeCompare(things[0].item_name) == 0){
                        item_index = document.getElementById("edit-field-item-" + ruleNumber + '-' + condition_count)[i].value;
                        break;
                    }
                }
                // console.log("item_index");
                // console.log(item_index)
                document.getElementById("edit-field-item-" + ruleNumber + '-' + condition_count).value = item_index;



                let comparision_index = "";
                let compareElement = document.getElementById("edit-field-item-" + ruleNumber + '-' + condition_count).nextSibling;

                // console.log("compareElement.length");
                // console.log(compareElement.length)

                for (let i=0; i<compareElement.length; i++){
                    if (compareElement[i].value.localeCompare(things[0].comparation) == 0){
                        comparision_index = compareElement[i].value;
                        break;
                    }
                }
                // console.log("comparision_index");
                // console.log(comparision_index)
                compareElement.value = comparision_index;




                let valueElement = document.getElementById("edit-field-item-" + ruleNumber + '-' + condition_count).nextSibling.nextSibling;
                // valueElement.value = parseInt(things[0].value)
                valueElement.value = things[0].value
                // console.log("valueElement");
                // console.log(valueElement.value)


                platform_id = things[0].platform_id
                // console.log("platform_id");
                // console.log(platform_id);

                let platform_id_index=-1;

                for (let i=0; i<platform_list.length; i++){
                    if (platform_list[i].platform_id.localeCompare(platform_id) == 0){
                        platform_id_index = i;
                    }
                }

                // initialize platform
                let selection = content.firstChild.nextSibling;

                if (bitwise.length > 0){
                    bitwise_operator = bitwise[0].bitwise_operator;
                    things = bitwise[0].things;
                    bitwise = bitwise[0].bitwise;
                }
                else{
                    break;
                }               
                condition_count = condition_count - 1;
 
            }

            //the button to add a field
            edit_operator_button_generator(ruleNumber, "edit-condition-field-" + ruleNumber);
            modalBody.appendChild(document.createElement("div"));
            modalBody.lastChild.setAttribute("class", "col-md-12 text-center");
            modalBody.lastChild.appendChild(document.createElement("span"));
            modalBody.lastChild.lastChild.setAttribute("id", "edit-plus-condition");
            modalBody.lastChild.lastChild.onclick = function() {
                // we give the function elements to create an id, so a common base-rulenumber-something different for every condition of this rule : the highest one + 1, or 0 if there isn't any condition yet
                let identifiant;
                if (document.getElementById("edit-condition-field-" + ruleNumber).lastChild) {
                    identifiant = document.getElementById("edit-condition-field-" + ruleNumber).lastChild.getAttribute("id");
                    identifiant = identifiant.split("-")[3];
                    identifiant = parseInt(identifiant) + 1;
                } else {
                    identifiant = 0;
                }
                add_condition_field("edit-condition-field-" + ruleNumber, "edit", ruleNumber + "-" + identifiant, aRule.rule_condition.bitwise.bitwise_operator);
            };

            modalBody.appendChild(document.createElement("h5"));
            modalBody.lastChild.innerHTML = "THEN";

            modalBody.appendChild(document.createElement("fieldset"));
            modalBody.lastChild.setAttribute("id", "edit-action-field-" + ruleNumber);

            //here we do the actions field
            for (let i = 0; i < rules[ruleNumber].rule_action.length; i++) {

                let content = add_action_field("edit-action-field-" + ruleNumber, "edit", ruleNumber + "-" + i);

                //initialize timer
                let action_timer = rules[ruleNumber].rule_action[i].timer;
                // console.log("action_timer");
                // console.log(action_timer)
                content.firstChild.setAttribute("value", action_timer);

                let selection = content.firstChild.nextSibling;
                for (let s, j = 0; s = selection.options[j]; j++) {
                    if (s.value == rules[ruleNumber].rule_action[i].action_type) {
                        selection.childNodes[j].setAttribute("selected", "selected");
                        break;
                    }
                }

                let edit_action_platform = selection.nextSibling;
                // console.log("edit_action_platform");
                // console.log(edit_action_platform[0])

                for (let j=0; j<edit_action_platform.length; j++){
                    if (edit_action_platform[j].innerHTML.includes(rules[ruleNumber].rule_action[i].platform_id)){
                        edit_action_platform[j].selected = "selected";
                        break;
                    }
                }

                let edit_action_item = edit_action_platform.nextSibling;
                // console.log("edit_action_item");
                // console.log(edit_action_item);

                for (let j=0; j<edit_action_item.length; j++){
                    if (edit_action_item[j].innerHTML.includes(rules[ruleNumber].rule_action[i].item_name)){
                        edit_action_item[j].selected = "selected";
                        break;
                    }
                }


                let edit_action_comparision = edit_action_item.nextSibling;
                // console.log("edit_action_comparision");
                // console.log(edit_action_comparision);

                for (let j=0; j<edit_action_comparision.length; j++){
                    // console.log(edit_action_comparision[j].value)
                    if (edit_action_comparision[j].value.localeCompare("EQ") == 0){
                        edit_action_comparision[j].selected = "selected";
                        break;
                    }
                }


                let edit_action_value = edit_action_comparision.nextSibling;
                // console.log("edit_action_value");
                // console.log(rules[ruleNumber].rule_action[i].new_state);
                edit_action_value.value = rules[ruleNumber].rule_action[i].new_state;


            }

            //the button to add a field
            modalBody.appendChild(document.createElement("div"));
            modalBody.lastChild.setAttribute("class", "col-md-12 text-center");
            modalBody.lastChild.appendChild(document.createElement("span"));
            modalBody.lastChild.lastChild.setAttribute("class", "glyphicon glyphicon-plus");
            modalBody.lastChild.lastChild.setAttribute("id", "edit-plus-action");
            modalBody.lastChild.lastChild.onclick = function() {
                // we give the function elements to create an id, so a common base-rulenumber-something different for every condition of this rule : the highest one + 1, or 0 if there isn't any condition yet
                let identifiant;
                if (document.getElementById("edit-action-field-" + ruleNumber).lastChild) {
                    identifiant = document.getElementById("edit-action-field-" + ruleNumber).lastChild.getAttribute("id");
                    identifiant = identifiant.split("-")[3];
                    identifiant = parseInt(identifiant) + 1;
                } else {
                    identifiant = 0;
                }
                add_action_field("edit-action-field-" + ruleNumber, "edit", ruleNumber + "-" + identifiant);
            };


            //content of the modal footer
            modalContent.appendChild(document.createElement("div"));
            modalContent.lastChild.setAttribute("class", "modal-footer");
            modalContent.lastChild.appendChild(document.createElement("button"));
            modalContent.lastChild.lastChild.setAttribute("type", "button");
            modalContent.lastChild.lastChild.setAttribute("class", "btn btn-default pull-right");
            modalContent.lastChild.lastChild.setAttribute("data-dismiss", "modal");
            modalContent.lastChild.lastChild.setAttribute("style", "margin-left: 7px");
            modalContent.lastChild.lastChild.innerHTML = "Close";

            modalContent.lastChild.appendChild(document.createElement("button"));
            modalContent.lastChild.lastChild.setAttribute("type", "button");
            modalContent.lastChild.lastChild.setAttribute("class", "btn btn-default btn-primary pull-right");
            modalContent.lastChild.lastChild.setAttribute("style", "color:white");
            modalContent.lastChild.lastChild.setAttribute("data-dismiss", "modal");
            modalContent.lastChild.lastChild.setAttribute("data-toggle", "modal");
            modalContent.lastChild.lastChild.setAttribute("data-target", "#modal-details-rule-" + ruleNumber);
            modalContent.lastChild.lastChild.onclick = function() {
                rule_edit(ruleNumber);
            }
            modalContent.lastChild.lastChild.innerHTML = "Edit";

            modalContent.lastChild.appendChild(document.createElement("button"));
            modalContent.lastChild.lastChild.setAttribute("type", "button");
            modalContent.lastChild.lastChild.setAttribute("class", "btn btn-default btn-danger pull-right");
            modalContent.lastChild.lastChild.setAttribute("data-dismiss", "modal");
            modalContent.lastChild.lastChild.onclick = function() {
                rule_remove(ruleNumber);
            };
            modalContent.lastChild.lastChild.setAttribute("style", "margin-left: 7px; color:white");
            modalContent.lastChild.lastChild.innerHTML = "Remove";


        }

        //called whent the edit button button is clicked
        // #E
        function rule_edit(ruleNumber) {
            let myRule = new Rule(document.getElementById("modal-edit-rule-" + ruleNumber).firstChild.firstChild.firstChild.lastChild.value);

            console.log("edit_rule")
            console.log(myRule)

            for (let i = 0; i < document.getElementById("edit-condition-field-" + ruleNumber).childNodes.length-3; i++) {
                // we get the first element, it depend if the condition is the first because of the bitwise operator
                // console.log("condition-field");
                // console.log(i);
                let timer, bitwise_operator;
                console.log("tagName")
                console.log(document.getElementById("edit-condition-field-" + ruleNumber).childNodes[i].firstChild.tagName);

                if (document.getElementById("edit-condition-field-" + ruleNumber).childNodes[i].firstChild.tagName.localeCompare("INPUT") == 0) {
                    bitwise_operator = "None";
                    timer = document.getElementById("edit-condition-field-" + ruleNumber).childNodes[i].firstChild;
                    console.log(timer);
                }
                else {
                    bitwise_operator = document.getElementById("edit-condition-field-" + ruleNumber).childNodes[i].firstChild;
                    console.log(bitwise_operator);
                    timer = bitwise_operator.nextSibling;
                    console.log(timer);
                    bitwise_operator = bitwise_operator.firstChild.innerHTML;
                    console.log(bitwise_operator);
                }


                // we get the platform element
                let platform = timer.nextSibling;
                console.log("platform");
                console.log(platform);

                //then the thing-item element (the sensor)
                let thing_item = platform.nextSibling;
                console.log("thing_item");
                console.log(thing_item);
                console.log(platform_list[thing_item.value.split("-")[1]].platform_id);

                //then the operator element
                let operator = thing_item.nextSibling;
                console.log("operator");
                console.log(operator);

                //finally the value element to compare
                let value = operator.nextSibling;

                //then we extract the intermediate data
                platform = platform.value;
                console.log("platform");
                console.log(platform);

                thing_item = thing_item.value.split("-"); // chi so things + chi so item
                console.log("thing_item");
                console.log(thing_item);


                console.log("operator.tagName");
                console.log(operator.tagName)

                //if it's in an html <p> tag, the operator is '=='
                if (operator.tagName.localeCompare("P") == 0) { // may have a bug, change not tested (localCompare)
                    operator = "EQ"; // #B
                    console.log("operator")
                    console.log(operator);
                } else if (operator.tagName.localeCompare("SELECT") == 0) {
                    operator = operator.options[operator.selectedIndex].value;
                    console.log(operator);
                }

                console.log("value.tagName ")
                console.log(value.tagName )

                if (value.tagName.localeCompare("INPUT") == 0) { // may have a bug, change not tested (localCompare)
                    value = value.value;
                    console.log(value);
                } else if (value.tagName.localeCompare("SELECT") == 0) {
                    value = value.options[value.selectedIndex].value;
                    console.log(value);
                }

                // then we have the correct data 
                // #C1 the following lines need to change according to the new rule data structure
                let theItem = platform_list[platform].things[thing_item[0]].items[thing_item[1]];
                console.log("theItem")
                console.log(theItem);

                let theThing = platform_list[platform].things[thing_item[0]];
                console.log("theThing");
                console.log(theThing);

                let aThing = new Thing(timer.value, theThing.thing_global_id, theItem.item_global_id, theItem.item_name, theItem.item_type, theThing.platform_id, operator, value);
                console.log("aThing");
                console.log(aThing);

                if (bitwise_operator.localeCompare("None") == 0) {
                    // console.log("add_rule_condition");
                    myRule.add_rule_condition(new Bitwise(aThing, bitwise_operator));
                } else {
                    add_a_bitwise(myRule.rule_condition.bitwise, new Bitwise(aThing, bitwise_operator), bitwise_operator);
                    console.log("add_a_bitwise")
                }
            }

            console.log("edit_rule")
            console.log(myRule)


            //Here we edit the actions to do in the rule we create
            for (let i = 0; i < document.getElementById("edit-action-field-" + ruleNumber).childElementCount; i++) {
                //first we get the timer element
                let timer = document.getElementById("edit-action-field-" + ruleNumber).childNodes[i].firstChild;

                let select = timer.nextSibling;
                console.log("select")
                console.log(select)

                let platform = select.nextSibling;
                console.log("platform");
                console.log(platform);

                //then the thing-item element (the sensor)
                let thing_item = platform.nextSibling;
                console.log("thing_item");
                console.log(thing_item);
                console.log(platform_list[thing_item.value.split("-")[1]].platform_id);

                //then the operator element
                let operator = thing_item.nextSibling;
                console.log("operator");
                console.log(operator);

                //finally the value element to compare
                let value = operator.nextSibling;

                //then we extract the intermediate data
                platform = platform.value;
                console.log("platform");
                console.log(platform);

                thing_item = thing_item.value.split("-"); // chi so things + chi so item
                console.log("thing_item");
                console.log(thing_item);


                console.log("operator.tagName");
                console.log(operator.tagName)

                let theItem = platform_list[platform].things[thing_item[0]].items[thing_item[1]];
                console.log("theItem")
                console.log(theItem);

                let theThing = platform_list[platform].things[thing_item[0]];
                console.log("theThing");
                console.log(theThing);

                console.log(value)

                
                myRule.add_action(timer.value, select.options[select.selectedIndex].value, theThing.thing_global_id, theItem.item_global_id, value.value);
            }
            // rules.splice(ruleNumber, 1, myRule);
            myRule.rule_status = "edit";
            myRule.rule_id = rules[ruleNumber].rule_id
            push_rule(myRule);
            list_existing_rule();

            rule_edit_display(ruleNumber);
            rule_details(ruleNumber);
        }

        //called whent the remove button button is clicked
        function rule_remove(ruleNumber) {
            if(confirm("Are you sure you want to remove the rule " + rules[ruleNumber].rule_name + " ?")) {
                rules[ruleNumber].rule_status = "disable";
                console.log(rules[ruleNumber]);
                console.log(typeof rules[ruleNumber]);
                push_rule(rules[ruleNumber]);
                list_existing_rule();
            }
        }
    </script>
