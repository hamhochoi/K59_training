<!DOCTYPE html>

<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>HPCC-IoT</title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
  <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="bower_components/Ionicons/css/ionicons.min.css">
  <!-- Daterange picker -->
  <link rel="stylesheet" href="bower_components/bootstrap-daterangepicker/daterangepicker.css">
  <!-- Toggle style  --> 
  <link href="/media/hamhochoi/Beo/OneDrive for Business 1/OneDrive - student.hust.edu.vn/OD/HPCC/ThingsBoard/K59_training-master/vungochoan/demo/plugins/bootstrap-toggle.min.css" rel="stylesheet">
  <!-- Daterange picker -->
  <link rel="stylesheet" href="bower_components/bootstrap-daterangepicker/daterangepicker.css">
  <!-- Dootstrap datepicker -->
  <link rel="stylesheet" href="bower_components/bootstrap-datepicker/dist/css/bootstrap-datepicker.min.css">
  <!-- Bootstrap Color Picker -->
  <link rel="stylesheet" href="bower_components/bootstrap-colorpicker/dist/css/bootstrap-colorpicker.min.css">
  <!-- Bootstrap time Picker -->
  <link rel="stylesheet" href="plugins/timepicker/bootstrap-timepicker.min.css">
  <!-- Boostrap toggle button -->
  <link href="/media/hamhochoi/Beo/OneDrive for Business 1/OneDrive - student.hust.edu.vn/OD/HPCC/ThingsBoard/K59_training-master/vungochoan/demo/plugins/bootstrap-toggle.min.css" rel="stylesheet">
  <!-- Notify animation -->
  <link rel="stylesheet" href="plugins/bootstrap-notify/animate.css">
  <!-- Amcharts (For the history diagrams) -->
  <link rel="stylesheet" href="/media/hamhochoi/Beo/OneDrive for Business 1/OneDrive - student.hust.edu.vn/OD/HPCC/ThingsBoard/K59_training-master/vungochoan/demo/plugins/export.css" type="text/css" media="all" />
  <!-- Theme style -->
  <link rel="stylesheet" href="dist/css/AdminLTE.min.css">
  <!-- AdminLTE Skins. We have chosen the skin-blue for this starter
        page. However, you can choose any other skin. Make sure you
        apply the skin class to the body tag so the changes take effect. -->
  <link rel="stylesheet" href="dist/css/skins/skin-blue.min.css">

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->

  <!-- Google Font -->
  <link rel="stylesheet"
        href="/media/hamhochoi/Beo/OneDrive for Business 1/OneDrive - student.hust.edu.vn/OD/HPCC/ThingsBoard/K59_training-master/vungochoan/demo/plugins/fonts.googleapis.css">
</head>
<!--
BODY TAG OPTIONS:
=================
Apply one or more of the following classes to get the
desired effect
|---------------------------------------------------------|
| SKINS         | skin-blue                               |
|               | skin-black                              |
|               | skin-purple                             |
|               | skin-yellow                             |
|               | skin-red                                |
|               | skin-green                              |
|---------------------------------------------------------|
|LAYOUT OPTIONS | fixed                                   |
|               | layout-boxed                            |
|               | layout-top-nav                          |
|               | sidebar-collapse                        |
|               | sidebar-mini                            |
|---------------------------------------------------------|
-->
<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">

  <!-- Main Header -->
  <header class="main-header">

    <!-- Logo -->
    <a href="#" class="logo">
      <!-- mini logo for sidebar mini 50x50 pixels -->
      <span class="logo-mini"><b>HU</b>ST</span>
      <!-- logo for regular state and mobile devices -->
      <span class="logo-lg">Real-time Monitoring</span>
    </a>

    <!-- Header Navbar -->
    <nav class="navbar navbar-static-top" role="navigation">


      <!-- Sidebar toggle button-->
      <div class="pull-left">
        <a href="#" class="sidebar-toggle" data-toggle="push-menu" role="button">
          <span class="sr-only">Toggle navigation</span>
        </a>
      </div>
      <!-- /.Sidebar toggle button -->
        
      <!-- Navbar Right Menu -->
      <div class="navbar-custom-menu pull-right">
        <ul class="nav navbar-nav">
          <!-- Control Sidebar Toggle Button -->
          <li>
            <a href="#" data-toggle="control-sidebar"><i class="fa fa-gears"></i></a>
          </li>
        </ul>
      </div>
      <!-- /.Navbar Right Menu -->
        
      <!-- search form (Optional) -->   
      <div class="col-md-2 pull-right">
          <form action="#" method="get" class="sidebar-form">
            <div class="input-group">
              <input type="text" name="q" class="form-control" placeholder="Search...">
              <span class="input-group-btn">
                  <button type="submit" name="search" id="search-btn" class="btn btn-flat"><i class="fa fa-search"></i>
                  </button>
                </span>
            </div>
          </form>
      </div>
      <!-- /.search form -->
    </nav>
    <!-- /.Header Navbar -->
  </header>
  <!-- Left side column. contains the logo and sidebar -->
  <aside class="main-sidebar">

    <!-- sidebar: style can be found in sidebar.less -->
    <section class="sidebar">


      <!-- Sidebar Menu -->
      <ul class="sidebar-menu" data-widget="tree">
        <!-- Optionally, you can add icons to the links -->
        <li class="active"><a href="realtime_diag.html"><i class="fa fa-link"></i> <span>Realtime Diagram</span></a></li>
        <li class="inactive"><a href="rules.html"><i class="fa fa-link"></i> <span>Rules</span></a></li>
        <!-- <li><a href="#"><i class="fa fa-link"></i> <span>Another Link</span></a></li> -->
        <li class="treeview">
          <a href="#"><i class="fa fa-link"></i> <span>More</span>
            <span class="pull-right-container">
                <i class="fa fa-angle-left pull-right"></i>
              </span>
          </a>
          <ul class="treeview-menu">
            <li><a href="#">There is nothing here</a></li>
            <li><a href="#">Same</a></li>
          </ul>
        </li>
      </ul>
      <!-- /.sidebar-menu -->
    </section>
    <!-- /.sidebar -->
  </aside>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <!-- Button to change the platform.
           Title and Subtitle are generate automaticaly with Javascript -->
      <h1>
        <div id="section_title"> <button type="button" class="btn btn-default" data-toggle="modal" data-target="#change_platform" onclick="display_platform_list();"><i class="fa fa-exchange"></i></button></div>
        
        <small id="section_subtitle"></small>
      </h1>
      <!-- Indicate if real-time is ON or OFF. Also allow to switch it state -->
      <ol class="breadcrumb">
        <div class="row">
            <div class="col-md-4 text-center">
                <input id="real_time_indicator" type="checkbox" checked data-toggle="toggle" data-on="On" data-off="Off" data-onstyle="success" data-offstyle="danger" disabled>
            </div>
            <div class="col-md-4 text-center">
                <button type="button" class="btn btn-default" onclick="start_realtime();"><i class="fa fa-play"></i></button><br> Real-time
            </div>
            <div  class="col-md-4 text-center">
                <button type="button" class="btn btn-default" onclick="stop_realtime();"><i class="fa fa-stop"></i></button><br> Stop
            </div>
        </div>
      </ol>
    </section>

    <!-- Main content -->
        <section class="content container-fluid">

      <!-------------------
        | My Page Content |
        ------------------->

            <!-- Default visibility : Hidden.
                 This is the modal box wich is display when you want to change 
                 the platform (By clicking on the button above (In the section title) -->
            <div class="modal fade" id="change_platform">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <!--  Box header -->
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title">Select one platform below</h4>
                        </div>
                        <!--  Box body -->
                        <div class="modal-body col-md-12">
                            <!--  Empty table. Auto-complete with javascript. Allow to display the list of platforms -->
                            <table class="table" id="platform_table">
                                <thead>
                                    <th>Name</th>
                                    <th>Id</th>
                                    <th>Status</th>
                                    <th>Port</th>
                                    <th> </th>
                                </thead>
                                <tbody id="platform_table_tbody">


                                </tbody>
                            </table>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-default pull-right" data-dismiss="modal">Cancel</button>
                        </div>
                    </div>
                    <!-- /.modal-content -->
                </div>
                <!-- /.modal-dialog -->
            </div>  

            
            <!--  Just a simple div with an id.  
                  It is like a landmark to display all boxes that contains diagram.
                  Content is generate with JS.  -->
            <div id="father"></div>
            
            <!--  Again a simple div with an id.
                  This one is for the modal box for all diagrams, it is not display
                  Content is generate with JS -->
            <div id="modal"></div>

            
            

    </section>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->

  <!-- Main Footer -->
  <footer class="main-footer">
    <!-- To the right -->
    <div class="pull-right hidden-xs">
      Anything you want
    </div>
    <!-- Default to the left -->
    <strong>Copyright &copy; 2018 <a href="#">Company</a>.</strong> All rights reserved.
  </footer>

  <!-- Control Sidebar -->
  <aside class="control-sidebar control-sidebar-dark">
    <!-- Create the tabs -->
    <ul class="nav nav-tabs nav-justified control-sidebar-tabs">
      <li class="active"><a href="#control-sidebar-home-tab" data-toggle="tab"><i class="fa fa-home"></i></a></li>
      <li><a href="#control-sidebar-settings-tab" data-toggle="tab"><i class="fa fa-gears"></i></a></li>
    </ul>
    <!-- Tab panes -->
    <div class="tab-content">
      <!-- Home tab content -->
      <div class="tab-pane active" id="control-sidebar-home-tab">
          Here the content of the left side.
      </div>
    
      <!-- Stats tab content -->
        <div class="tab-pane" id="control-sidebar-stats-tab">
          
        </div>
      <!-- /.tab-pane -->
        
      <!-- Settings tab content -->
      <div class="tab-pane" id="control-sidebar-settings-tab">
          Here is the right side.
      </div>
      <!-- /.tab-pane -->
    </div>
  </aside>
  <!-- /.control-sidebar -->
  <!-- Add the sidebar's background. This div must be placed
  immediately after the control sidebar -->
  <div class="control-sidebar-bg"></div>
</div>
<!-- ./wrapper -->

<!-- REQUIRED JS SCRIPTS -->

<!-- jQuery 3 -->
<script src="../bower_components/jquery/dist/jquery.min.js"></script>
<!-- Bootstrap 3.3.7 -->
<script src="../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
<!-- AdminLTE App -->
<script src="../dist/js/adminlte.min.js"></script>
<!-- FastClick -->
<script src="../bower_components/fastclick/lib/fastclick.js"></script>
    
<!-- date-range-picker -->
<script src="../bower_components/moment/min/moment.min.js"></script>
<script src="../bower_components/bootstrap-daterangepicker/daterangepicker.js"></script>
<!-- bootstrap datepicker -->
<script src="../bower_components/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js"></script>
<!-- bootstrap color picker -->
<script src="../bower_components/bootstrap-colorpicker/dist/js/bootstrap-colorpicker.min.js"></script>
<!-- bootstrap time picker -->
<script src="../plugins/timepicker/bootstrap-timepicker.min.js"></script>

<!-- bootstrap notify -->
<script src="../plugins/bootstrap-notify/bootstrap-notify.js"></script>
<script src="../plugins/bootstrap-notify/bootstrap-notify.min.js"></script>
    
<!-- toogle button -->
<script src="./bower_components/bootstrap-toggle.min.js"></script>
<!-- Ajax -->
<script src="./test/ajax.js" type="text/javascript"></script>

<!-- ChartJS 
<script src="bower_components/chart.js/Chart.js"></script> -->
<script src="./bower_components/Chart.min.js"></script>

<!-- amChart -->
<script src="/media/hamhochoi/Beo/OneDrive for Business 1/OneDrive - student.hust.edu.vn/OD/HPCC/ThingsBoard/K59_training-master/vungochoan/demo/plugins/amcharts.js"></script>
<script src="/media/hamhochoi/Beo/OneDrive for Business 1/OneDrive - student.hust.edu.vn/OD/HPCC/ThingsBoard/K59_training-master/vungochoan/demo/plugins/serial.js"></script>
<script src="/media/hamhochoi/Beo/OneDrive for Business 1/OneDrive - student.hust.edu.vn/OD/HPCC/ThingsBoard/K59_training-master/vungochoan/demo/plugins/light.js"></script>
<script src="/media/hamhochoi/Beo/OneDrive for Business 1/OneDrive - student.hust.edu.vn/OD/HPCC/ThingsBoard/K59_training-master/vungochoan/demo/plugins/export.min.js"></script>

<!-- Default passive event -->
<script type="text/javascript" src="/media/hamhochoi/Beo/OneDrive for Business 1/OneDrive - student.hust.edu.vn/OD/HPCC/ThingsBoard/K59_training-master/vungochoan/demo/plugins/index.js"></script>

        
<script src="config/config.js"></script>
    
<!-- Optionally, you can add Slimscroll and FastClick plugins.
     Both of these plugins are recommended to enhance the
     user experience. -->
    
<script type="text/javascript">
    "use strict";
    
    
    //Define some constant, API domain will change so it is easier like that
    // const sensor_API = "http://192.168.60.248:5000";


    const url_sources                            = sensor_API+'/api/sources';
    const url_platforms                         = sensor_API+'/api/platforms';
    const url_sources_history                    = sensor_API+'/api/history/sources/'; //+<thing_global_id>/<start_time>/<end_time>
    const url_metric_history                      = sensor_API+'/api/history/metric/'; //+<MetricId>/<start_time>/<end_time>
    const url_sources_from_PlatformId           = sensor_API+'/api/sources/platform_id/';
    const url_sources_history_from_PlatformId   = sensor_API+'/api/history/sources/platform_id/';
    
    //Just set a default platform.

    var platform_list = get_data_from_api(url_platforms);
    var id_current_platform = platform_list[0].PlatformId; //HomeAssistant
    console.log("id_current_platform")
    console.log(id_current_platform)
    
    
    //Some variables usefull for further
    var diag_table = {}; // Stock diagrams to use them easly
    var repetition; // Contain a function (setInterval)
    //for realtime    /\
    //                ||
    //for the history \/
    var start_date;
    var end_date;
    var diag_table_history = {}; // Stock history diagrams to use them easly
    
    // Start the application with a default platform
    get_data_from_api_async(load_sources, url_sources_from_PlatformId+id_current_platform, id_current_platform);
    // Arguments are: (callback, url, id)
    // var id_current_platform = this.arguments

    // console.log("id_current_platform")
    // console.log(id_current_platform)
    
    
    
    
    // ==============       API function communication      ============== //
    
    function stop_realtime(){
        // Because you can't change it state if it is diable..
        $('#real_time_indicator').bootstrapToggle('enable'); 
        $('#real_time_indicator').bootstrapToggle('off');
        $('#real_time_indicator').bootstrapToggle('disable');
        clearInterval(repetition); // Stop the real-time
    }
    function start_realtime(){
        //Same than stop_realtime
        $('#real_time_indicator').bootstrapToggle('enable');
        $('#real_time_indicator').bootstrapToggle('on');
        $('#real_time_indicator').bootstrapToggle('disable');
        get_sources_for_update_from_api(); // It call 'get_data_from_api_async'
        repetition = setInterval(get_sources_for_update_from_api, 5000); // Define wich function to invoque at the end of the duration.
    } // Time between 2 update
    
    function get_data_from_api(url){
        var request = new XMLHttpRequest();
        request.open('GET',url, false);  // `false` makes the request synchronous
        request.send(null);

        if (request.status === 200 || 201) { // Check if there is some error
            return JSON.parse(request.responseText);
        }else{
            alert(request.status);
        }
      } // Get data from the API
    function get_data_from_api_async(callback, url, id_current_platform){
        var xhr = new XMLHttpRequest();
        xhr.callback = callback;
        xhr.arguments = Array.prototype.slice.call(arguments, 2);
        xhr.onload = xhrSuccess;
        xhr.onerror = xhrError;
        xhr.open("GET", url, true);
        xhr.send(null);
      } // Get data from the API (asynchronous)
    function get_sources_for_update_from_api(){
        // Just call the function above, but it change the callback with 'update' function to update the value (for the real-time)
        get_data_from_api_async(update, url_sources_from_PlatformId+id_current_platform);
    } 
    function xhrSuccess() {
        this.callback.apply(this); 
    } // In case of success, call the callback function with parameters
    function xhrError() { 
        console.error(this.statusText); 
    } // In case of error, print the error text (if there is)
    
    function get_list_of_platform(callback){
        get_data_from_api_async(callback, url_platforms);
    }
    
    function notificate(title, message, type, delay){
        $.notify({
            // options
            icon: 'glyphicon glyphicon-warning-sign',
            title: title,
            message: message,
            target: '_blank'
        },{
            // settings
            element: 'body',
            type: type,
            allow_dismiss: true,
            newest_on_top: true,
            offset: 20,
            spacing: 10,
            z_index: 1031,
            delay: delay,
            timer: 1000,
            url_target: '_blank',
            mouse_over: 'pause',
            animate: {
                enter: 'animated zoomInRight',
                exit: 'animated zoomOutRight'
            },
            icon_type: 'class'
        });
    } // Print a notification on the top-left of the screen
    
    
    
    
    
    // ==============       Diagrams function      ============== //
   
    function load_sources(request){
        //console.log(this);
        
        //Get the arguments of the 'father' function (we are in the callback of 'get_data_from_api_async')
        var PlatformId = this.arguments;
        console.log("this is PlatformId")
        console.log(PlatformId)
        
        //It is just to get the NAME of the platform.
        var platforms = get_data_from_api(url_platforms); // The only one synchronous query
        
        //Here, sources_data get the result of the 'father' function (convert in JSON type)
        var sources_data = JSON.parse(this.responseText);
        console.log("sources_data")
        console.log(sources_data)
        
        
        var j=0;
        var bool=true;
        while(bool){ // Simple loop to find something. (Here the name of the platform)
            if(sources_data[j].information.PlatformId == platforms[j].PlatformId){
                var txt_title_section = document.createTextNode(platforms[j].PlatformName+" ");
                var txt_title_subsection = document.createTextNode("> "+sources_data[j].information.PlatformId);
                bool=false;
            }else{
                var txt_title_section = document.createTextNode("Not found");
                var txt_title_subsection = document.createTextNode("Not found");
            }
            j++;
        }
        
        //Print values of the name (and the ID) in the 'h1' tag BEFORE the button to sitch of platform
        var subtitle_section = document.getElementById("section_subtitle");
        subtitle_section.appendChild(txt_title_subsection);
        var title_section = document.getElementById("section_title");
        title_section.prepend(txt_title_section);
        
        
        // Here we will fill the content of our empty 'div'
        var father = document.getElementById("father");
        var modal = document.getElementById('modal');
        
        var i=0; // 'i' : For sources
        var h=0; // 'h' : For metrics in sources
        var nb_sources = sources_data.length; // Exemple : For HomeAssistant, it is always 1
                                            //           For sourcesBoard, it can be 3 or 4
        

        for (i=0; i<nb_sources; i++){ // Loop in the sources
            var nb_metrics = sources_data[i]['metrics'].length
            //console.log('nb_metrics> '+ nb_metrics);
            for (var h=0; h<nb_metrics; h++){ // If there is many metrics in one sources it will be a loop
            
                //Now generate some html tag with id and class to display diagrams
                //All the code below is only for one sensor, that is why we have a loop above
                
                var div_col_md = document.createElement('div');
                div_col_md.setAttribute('class', 'col-md-4');



                var div_box = document.createElement('div');
                div_box.setAttribute('class', 'box');

                var div_box_header = document.createElement('div');
                div_box_header.setAttribute('class', 'box-header with-border');

                var button_overlay = document.createElement('button');
                button_overlay.setAttribute('class', 'btn btn-default pull-right');
                button_overlay.setAttribute('type', 'button');
                button_overlay.setAttribute('data-toggle', 'modal');
                button_overlay.setAttribute('data-target', '#'+i+''+h);
                
                // When you click on this button, it display a modal box that contains diagram and datepicker for the history part
                button_overlay.setAttribute('onclick', 'create_history_diagram("'+sources_data[i]['metrics'][h].MetricId+'","'+sources_data[i]['metrics'][h].MetricType+'");');
                // console.log(sources_data[i]['metrics'][h].MetricType);
                var i_logo_info = document.createElement('i');
                i_logo_info.setAttribute('class', 'fa fa-history');
                button_overlay.appendChild(i_logo_info);

                var box_title = document.createElement('h3');
                var title = document.createTextNode(sources_data[i]['metrics'][h].MetricName);
                box_title.setAttribute('class', 'box_title');
                box_title.appendChild(title);
                box_title.appendChild(button_overlay);
                //div_box_header.appendChild(button_overlay);
                div_box_header.appendChild(box_title);

                var div_box_tools = document.createElement('div');
                div_box_tools.setAttribute('class', 'box_tools pull-right');

                var div_btn_grp = document.createElement('div');
                div_btn_grp.setAttribute('class', 'btn-group');
                div_btn_grp.setAttribute('id', 'realtime');
                div_btn_grp.setAttribute('data-toggle', 'btn-toggle');

                var button_play = document.createElement('button');
                button_play.setAttribute('class', 'btn btn-default btn-xs active');
                button_play.setAttribute('type', 'button');
                button_play.setAttribute('data-toggle', 'on');

                var i_logo_pause = document.createElement('i');
                i_logo_pause.setAttribute('class', 'fa fa-pause');

                var div_box_body = document.createElement('div');
                div_box_body.setAttribute('class', 'box-body');

                var div_diagram = document.createElement('div');
                div_diagram.setAttribute('class', 'chart');

                var canva_diagram = document.createElement('canvas');
                canva_diagram.setAttribute('id', sources_data[i]['metrics'][h].MetricId); // This is for the real-time diagram. We will use it later
                canva_diagram.setAttribute('style', 'max-height: 230px;');
                div_diagram.appendChild(canva_diagram);






                div_box_body.appendChild(div_diagram);

                div_box.appendChild(div_box_header);
                div_box.appendChild(div_box_body)
                
                div_col_md.appendChild(div_box);
                
                
                father.appendChild(div_col_md);
                
               
                // All the code above is for the real-time diagram
                
                //                  ****************************************                  
                
                // Below, it is all the code for the modal box, for the history part
                
                

                //MODAL BOX

                //Box : Header
                var div_modal_header = document.createElement('div');
                div_modal_header.setAttribute('class', 'modal-header');

                var button_modal_close = document.createElement('button'); //This button dosen't work :/
                button_modal_close.setAttribute('class', 'close');
                button_modal_close.setAttribute('type', 'button');
                button_modal_close.setAttribute('data-dissmiss', 'modal');
                button_modal_close.setAttribute('aria-label', 'Close');

                var span_modal_cross = document.createElement('span');
                var cross = document.createTextNode('x'); //exhenge in html
                span_modal_cross.setAttribute('class', 'aria-title');


                var title_modal = document.createElement('h4');
                title_modal.setAttribute('class', 'modal-title');
                var title_modal_txt = document.createTextNode('History - '+sources_data[i]['metrics'][h].MetricName); //Name

                title_modal.appendChild(title_modal_txt);
                span_modal_cross.appendChild(cross);
                button_modal_close.appendChild(span_modal_cross);
                //div_modal_header.appendChild(button_modal_close);
                div_modal_header.appendChild(title_modal);


                //Box : Body
                var div_modal_body = document.createElement('div');
                div_modal_body.setAttribute('class','modal-body');




                //SECOND ROW
                var div_modal_body_rowB = document.createElement('div');
                div_modal_body_rowB.setAttribute('class','row');

                //Calendar
                var div_modal_body_rowB_form_group = document.createElement('div');
                div_modal_body_rowB_form_group.setAttribute('class','form-group pull-left col-md-12'); //pull-right useless ?

                var div_modal_body_rowB_form_group_input_group = document.createElement('div');
                div_modal_body_rowB_form_group_input_group.setAttribute('class','input-group');

                var div_modal_body_rowB_form_group_input_group_addon = document.createElement('div');
                div_modal_body_rowB_form_group_input_group_addon.setAttribute('class', 'input-group-addon');
                var i_modal_body_rowB_form_group_input_group_addon =  document.createElement('i');
                i_modal_body_rowB_form_group_input_group_addon.setAttribute('class','fa fa-clock-o');
                div_modal_body_rowB_form_group_input_group_addon.appendChild(i_modal_body_rowB_form_group_input_group_addon);

                var input_modal_body_rowB_form_group_input_group = document.createElement('input');
                input_modal_body_rowB_form_group_input_group.setAttribute('type','text');
                input_modal_body_rowB_form_group_input_group.setAttribute('class','form-control');
                input_modal_body_rowB_form_group_input_group.setAttribute('id', 'calendar-'+sources_data[i]['metrics'][h].MetricId.replace(/\./g,'-'));// Same here, we use the metric id wich is unique. But calandar use Jquerry so we can't use dots in it id. So we replace all the dots with this : -  ( /g : recursively)

                div_modal_body_rowB_form_group_input_group.appendChild(div_modal_body_rowB_form_group_input_group_addon);
                div_modal_body_rowB_form_group_input_group.appendChild(input_modal_body_rowB_form_group_input_group);
                div_modal_body_rowB_form_group.appendChild(div_modal_body_rowB_form_group_input_group);


                //Predefine date
                var div_modal_body_rowB_predefine_date = document.createElement('div');
                div_modal_body_rowB_predefine_date.setAttribute('id','predefine_date-'+sources_data[i]['metrics'][h].MetricId.replace(/\./g,'-')); // It is the same than the calandar
                div_modal_body_rowB_predefine_date.setAttribute('style','background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc; left: 15px;');
                div_modal_body_rowB_predefine_date.setAttribute('class','pull-left col-md-5');

                var i_predefine_date_calendar = document.createElement('i');
                i_predefine_date_calendar.setAttribute('class','fa fa-calendar');
                var span_predefine_date = document.createElement('span');
                var i_predefine_date_calendar_down = document.createElement('i');
                i_predefine_date_calendar_down.setAttribute('class','fa fa-caret-down');

                div_modal_body_rowB_predefine_date.appendChild(i_predefine_date_calendar);
                div_modal_body_rowB_predefine_date.appendChild(span_predefine_date);
                div_modal_body_rowB_predefine_date.appendChild(i_predefine_date_calendar_down);

                
                
                
                div_modal_body_rowB.appendChild(div_modal_body_rowB_form_group); // Calendar
                div_modal_body_rowB.appendChild(div_modal_body_rowB_predefine_date); // Predefine date
               

                //THIRD ROW
                var div_modal_body_rowC = document.createElement('div');
                div_modal_body_rowC.setAttribute('class','row');
                var div_modal_body_rowC_col = document.createElement('div');
                div_modal_body_rowC_col.setAttribute('class','col-md-12');
                var div_modal_body_rowC_col_chart = document.createElement('div');
                div_modal_body_rowC_col_chart.setAttribute('style','width: 100%; height: 300px;');
                div_modal_body_rowC_col_chart.setAttribute('id',sources_data[i]['metrics'][h].MetricId+'_history'); // This is for the history diagram, we will get this 'div' later

                div_modal_body_rowC_col.appendChild(div_modal_body_rowC_col_chart);
                div_modal_body_rowC.appendChild(div_modal_body_rowC_col);


                //ADD ROWS IN BODY BOX
                //div_modal_body.appendChild(div_modal_body_rowA);
                div_modal_body.appendChild(div_modal_body_rowB);
                div_modal_body.appendChild(div_modal_body_rowC);




                //Box : Footer
                var div_modal_footer = document.createElement('div');
                div_modal_footer.setAttribute('class','modal-footer');

                var button_modal_footer = document.createElement('button');
                button_modal_footer.setAttribute('type','button');
                button_modal_footer.setAttribute('class','btn btn-default pull-right');
                button_modal_footer.setAttribute('data-dismiss','modal');
                var txt_button_modal_footer = document.createTextNode('Ok'); //+Name
                button_modal_footer.appendChild(txt_button_modal_footer);
                div_modal_footer.appendChild(button_modal_footer);


                //All
                var div_box = document.createElement('div');
                div_box.setAttribute('class', 'modal fade');
                div_box.setAttribute('id', ''+i+''+h); // Create automaticaliy the id

                var div_modal_dialog = document.createElement('div');
                div_modal_dialog.setAttribute('class', 'modal-dialog');

                var div_modal_content = document.createElement('div');
                div_modal_content.setAttribute('class', 'modal-content');

                div_modal_content.appendChild(div_modal_header);
                div_modal_content.appendChild(div_modal_body);
                div_modal_content.appendChild(div_modal_footer);

                div_modal_dialog.appendChild(div_modal_content);

                div_box.appendChild(div_modal_dialog);

                modal.appendChild(div_box);
                
                //      /!\    IMPORTANT     /!\
                create_diagram(sources_data[i]['metrics'][h]);
                // When all the HTML for one metric is created, we create the diagram for it
                
                
            } //End : For (metrics)
        }  //End : For (sources)
        
        id_current_platform = PlatformId;
        start_realtime();
    } // Load all the sources from the platform
    
    function create_diagram(metric){
        //console.log(thing.thing_type);
        // Thank to the parameter we can konw the metric type
        // So it call the correct function wich correspond to the sensor type
        switch(metric.MetricType){
            case 'Switch':
            case 'light': create_diagram_light(metric);
                break;
            case 'binary_sensor' : create_diagram_binary(metric);
                break;
            case 'sensor': create_diagram_sensor(metric);
                break;
            case 'updater': console.log("\n**********\nIDK this type (updater).\n**********\n");
                break;
            case 'Gauge': create_diagram_gauge(metric);
                break;
            default: notificate('ERROR', '- There is no diagram for the type <'+metric.MetricType+'> for the moment.', 'info', 3000);
                break;
        }
        //To add diagrams types, just add a condition to the switch with a new function. Also, copy and paste one function below and rename it. You can change parameter if you want, but if there is one to change it is the diagram type, it is in config > type: '#' - Check the Chart.js doc for more informations
        
    } // Chose the great type and call it function
    
    // -> The function wich is called : Create differents types of diagram
    function create_diagram_binary(metric){
            var ctx = document.getElementById(metric.MetricId).getContext("2d"); //Previously, we created one canva with this ID. (in 'load_sources' function)
            // Some parameter for the diagram
            // If you want more, see 'https://www.chartjs.org/'
            var data = {
                    labels: [],
                    datasets: [{
                        label: metric.MetricName,
                        data: [], // Empty because we will add the data later (In update part)
                        lineTension: 0,
                        steppedLine: true, 
                        borderWidth: 3,
                        pointRadius: 2,
                        borderColor: 'rgba(0,0,0,1)',
                        backgroundColor: 'rgba(0,0,0,0)'
                    }]
                }; 
            var config = {
                type: 'line',
                data: data,
                options: {
                    scales: {
                        yAxes: [{
                            ticks: { min:0, max:1, stepSize:1},
                            gridLines: { color: "rgba(0, 0, 0, 0)" }
                        }],
                        xAxes: [{
                            // space between each bar
                            barPercentage: 1.25,
                            gridLines: { color: "rgba(0, 0, 0, 0)" }
                        }]
                    },
                    legend: {
                        display: false
                    },
                    tooltips: {
                        enabled: false
                    }
                }
            };
            var myChart = new Chart(ctx, config);
            var id = metric.MetricId;
            diag_table[id] = myChart; // stock the diagram to use it later.
      }
    function create_diagram_light(metric){
            var ctx = document.getElementById(metric.MetricId).getContext("2d");
            // Some parameter for the diagram
            // If you want more, see 'https://www.chartjs.org/'
            var data = {
                labels: [],
                datasets: [{
                    label: metric.MetricName,
                    data: [],
                    lineTension: 0,
                    steppedLine: true, // try to put 'after' ..
                    //borderWidth: 3,
                    //pointRadius: 2,
                    borderColor: 'rgba(0,200,0,1)',
                    backgroundColor: 'rgba(0,0,0,0)' 
                }]
            };
            var config = {
                type: 'line',
                data: data,
                options: {
                    scales: {
                        yAxes: [{
                            ticks: { min:0, max:1, stepSize:1},
                            gridLines: { color: "rgba(0, 0, 0, 0)" }
                        }],
                        xAxes: [{

                            // space between each bar
                            barPercentage: 1.25,
                            gridLines: { color: "rgba(0, 0, 0, 0)" }
                        }]
                    },
                    legend: {
                        display: false
                    }         
                }
            };
            var myChart = new Chart(ctx, config);
            var id = metric.MetricId;
             diag_table[id] = myChart; // stock the diagram to use it later.
      }
    function create_diagram_sensor(metric){
          var ctx = document.getElementById(metric.MetricId);
          // Some parameter for the diagram
          // If you want more, see 'https://www.chartjs.org/'
          var data = {
                labels: [],
                datasets: [{ 
                    data: [],
                    label: metric.MetricName,
                    borderColor: 'rgba(0,0,200,1)',
                    fill: false
                  }]
              };
          var config = {
                type: 'line',
                data: data,
                options: {
                    title: {
                        display: true,
                    },
                    legend: {
                        display: false
                    },
                    scales: {
                        xAxes: [{
                            time: 'time',
                            time: {
                                displayFormats: {
                                    'millisecond': 'MMM DD',
                                    'second': 'MMM DD',
                                    'minute': 'MMM DD',
                                    'hour': 'MMM DD',
                                    'day': 'MMM DD',
                                    'week': 'MMM DD',
                                    'month': 'MMM DD',
                                    'quarter': 'MMM DD',
                                    'year': 'MMM DD',
                                }
                            }
                        }],
                        yAxes: [{
                            ticks: {beginAtZero: true},
                        }]
                    }
                }
            };
          var myChart = new Chart(ctx, config);
          var id = metric.MetricId;
          diag_table[id] = myChart; // stock the diagram to use it later.
      }

    function create_diagram_gauge(metric){
          var ctx = document.getElementById(metric.MetricId);
          // Some parameter for the diagram
          // If you want more, see 'https://www.chartjs.org/'
          var data = {
                labels: [],
                datasets: [{ 
                    data: [],
                    label: metric.MetricName,
                    borderColor: 'rgba(0,0,200,1)',
                    fill: false
                  }]
              };
          var config = {
                type: 'line',
                data: data,
                options: {
                    title: {
                        display: true,
                    },
                    legend: {
                        display: false
                    },
                    scales: {
                        xAxes: [{
                            time: 'time',
                            time: {
                                displayFormats: {
                                    'millisecond': 'MMM DD',
                                    'second': 'MMM DD',
                                    'minute': 'MMM DD',
                                    'hour': 'MMM DD',
                                    'day': 'MMM DD',
                                    'week': 'MMM DD',
                                    'month': 'MMM DD',
                                    'quarter': 'MMM DD',
                                    'year': 'MMM DD',
                                }
                            }
                        }],
                        yAxes: [{
                            ticks: {beginAtZero: true},
                        }]
                    }
                }
            };
          var myChart = new Chart(ctx, config);
          var id = metric.MetricId;
          diag_table[id] = myChart; // stock the diagram to use it later.
      }

    function update() {
        //This = undefined when the function 'update' was not called by the callback of 'get_data_from_api_async' function
        if(this == undefined)  get_data_from_api_async(update, url_sources_from_PlatformId+id_current_platform);
        else{
            var data = JSON.parse(this.responseText);// Return of get_data_from_api_async (xhr_success)
            for(var i=0; i<data.length; i++){ // sources
                for(var j=0; j<data[i]['metrics'].length; j++){ // metrics in sources
                    diag_update(data[i]['metrics'][j]);  // Pass an metric as argument
                }
            }
        }
    } // Update all diagrams
    function diag_update(metric){
        // var api_time = metric.DataPoint.TimeCollect; // X value
        var api_time = new Date(); api_time = api_time.toLocaleString();


        // console.log("api_time")
        // console.log(api_time)

        var value = metric.DataPoint.Value; // Y value
        // console.log("value")
        var type_of_value = typeof(value)
        // console.log(type_of_value)


        if(diag_table[metric.MetricId] != undefined){ // Check if there is an error during the creation of the diagram
            var chart = diag_table[metric.MetricId]; // Get the diagram saved in the array
            var config = chart.config;
            var ctx = chart.ctx;
            config.data.labels.push(moment.utc(api_time).format('LTS')); // Add the X value to the diagram (Convert the type to HH:MM:SS  (= 'LTS'))
            
            //By checking the sensor type, convert it value to a correct value that the diagram can unerstand (Like ON = 1 and OFF = 0)  And add the Y value to the diagram
            switch(metric.MetricType){
                case 'binary_sensor':
                case 'light':
                case 'Switch':
                    if(value === 'on' ||value === 'ON' || value == 1) config.data.datasets[0].data.push(1);
                else if (value === 'off' || value === 'OFF' || value == 0) config.data.datasets[0].data.push(0);
                    break;
                case 'sensor': config.data.datasets[0].data.push(value);
                    break;
                case 'Gauge': 
                    if (type_of_value.localeCompare("string") == 0){
                      if (value.localeCompare("on") == 0){
                        value = 1;
                      }
                      else if (value.localeCompare("off") == 0){
                        value = 0;
                      }
                      // console.log("value")
                      // console.log(value)
                    }

                    config.data.datasets[0].data.push(value);
                    break;
                case 'Number': config.data.datasets[0].data.push(value);
                    break;  
                default: console.log("\n**********\nIDK this type. (diag_update)\n**********\n")
                    break;
            }  

            if(config.data.labels.length > 10){ //number of point value displayed on the graph
                config.data.labels.shift();
                config.data.datasets[0].data.shift();
            }
            
            chart.update(); // Update the data of the diagram with new X and Y values
        }else console.log('The diagram does not exist.');
        
      } // Update one diagram
    
    
    
    
    
    // ==============       Change platform        ============== //
    
    function display_platform_list(){
        //Exactly the same than 'update' function.
        //This is undefined when the function 'update' was not called by the callback of 'get_data_from_api_async' function
        if(this == undefined) get_data_from_api_async(display_platform_list, url_platforms);
        else{
            console.log(this);
            var platforms_data = JSON.parse(this.responseText);//get_data_from_api(url_platforms);



            var table_platform = document.getElementById('platform_table');
            var table_platform_tbody = document.getElementById('platform_table_tbody');

            //Clear the table
            while(table_platform_tbody.firstChild){
                table_platform_tbody.removeChild(table_platform_tbody.firstChild);}

            //Fill the table with platforms informations
            for (var i=0; i<platforms_data.length;i++){

                var tr_table_platform = document.createElement('tr');

                var td_tr_table_PlatformName = document.createElement('td');
                var txt_PlatformName = document.createTextNode(platforms_data[i].PlatformName);
                td_tr_table_PlatformName.appendChild(txt_PlatformName);

                var td_tr_table_PlatformId = document.createElement('td');
                var txt_PlatformId = document.createTextNode(platforms_data[i].PlatformId);
                td_tr_table_PlatformId.appendChild(txt_PlatformId);

                var td_tr_table_PlatformStatus = document.createElement('td');
                var txt_PlatformStatus = document.createTextNode(platforms_data[i].PlatformStatus);
                td_tr_table_PlatformStatus.appendChild(txt_PlatformStatus);

                var td_tr_table_platform_port = document.createElement('td');
                var txt_platform_port = document.createTextNode(platforms_data[i].PlatformPort);
                td_tr_table_platform_port.appendChild(txt_platform_port);

                var td_tr_table_platform_button = document.createElement('td');
                var button_td_tr_table_platform = document.createElement('button');
                button_td_tr_table_platform.setAttribute('type','button');
                if(platforms_data[i].PlatformStatus == 'inactive')
                    button_td_tr_table_platform.disabled = true;
                button_td_tr_table_platform.setAttribute('class','btn-default btn-xs');
                button_td_tr_table_platform.setAttribute('data-dismiss','modal');
                button_td_tr_table_platform.setAttribute('onclick','change_platform("'+platforms_data[i].PlatformId+'");');
                var i_logo_button_table_platform = document.createElement('i');
                i_logo_button_table_platform.setAttribute('class','fa fa-check');
                button_td_tr_table_platform.appendChild(i_logo_button_table_platform);
                td_tr_table_platform_button.appendChild(button_td_tr_table_platform);

                //change the order of column
                tr_table_platform.appendChild(td_tr_table_PlatformName);
                tr_table_platform.appendChild(td_tr_table_PlatformId);
                tr_table_platform.appendChild(td_tr_table_PlatformStatus);
                tr_table_platform.appendChild(td_tr_table_platform_port);
                tr_table_platform.appendChild(td_tr_table_platform_button);

                table_platform_tbody.appendChild(tr_table_platform);
            }
        
        }
        
    } // Display the platform list (when you want to change of platform)
    function reset_page(){
        // Get both container
        var container_diag = document.getElementById('father');
        var container_modal = document.getElementById('modal');
        
        // And clear there content
        while(container_diag.firstChild){
            container_diag.removeChild(container_diag.firstChild);
        }
        while(container_modal.firstChild){
            container_modal.removeChild(container_modal.firstChild);
        }
        // Clear title and subtitle too
        var subtitle_section = document.getElementById("section_subtitle");
        subtitle_section.removeChild(subtitle_section.firstChild);
        var title_section = document.getElementById("section_title");
        title_section.removeChild(title_section.firstChild);
    } // Clear all the diagrams currently displaying
    
    function change_platform(id_new_platform){ // This function is call by clicking on one button displayed in the platform list
        
        stop_realtime(); // Put real-time in pause
        reset_page(); // Reset the content
        get_data_from_api_async(load_sources, url_sources_from_PlatformId+id_new_platform, id_new_platform); // Print new content
        //start_realtime(); // Restart the real-time // If needed
        notificate('', ' Platform changed successfully.', 'success', 5000);
    }// Call different methods to display the new platform
    
    
    
    
    
    // ==================       HISTORY        ================== //
    // Find wich diagram to print
    function create_history_diagram(sensor_id, sensor_type){ // = MetricId 
        switch(sensor_type){
            case 'Switch':
            case 'light': create_history_diagram_light(sensor_id);;
                break;
            case 'binary_sensor' : create_history_diagram_binary_sensor(sensor_id);
                break;
            case 'sensor': create_history_diagram_sensor(sensor_id);
                break;
            case 'Gauge': create_history_diagram_gauge(sensor_id);
                break;
            default: notificate('ERROR', '- There is no diagram for the type <'+sensor_type+'> for the moment.', 'info', 3000);
                break;
        }
    } // Find the sensor type
    
    // Create an empty diagram for <sensor> type. It is exactly the same than the diagrams for real-data (1. Find type / 2. Create the diagram)
    function create_history_diagram_gauge(sensor_id){
        var chartData = [];
        var chart = AmCharts.makeChart(sensor_id+'_history', {
            "type": "serial",
            "theme": "light",
            "marginRight": 80,
            "autoMarginOffset": 20,
            "marginTop": 7,
            "dataProvider": chartData,
            "valueAxes": [{
                "axisAlpha": 0.2,
                "dashLength": 1,
                //"minimum": 0,  //BAD : Values can't be negative
                "position": "left"
            }],
            "mouseWheelZoomEnabled": true,
            "graphs": [{
                "id": "g1",
                "balloonText": "[[value]]",
                "bullet": "round",
                "bulletBorderAlpha": 1,
                "bulletColor": "#FFFFFF",
                "hideBulletsCount": 50,
                "title": "red line",
                "valueField": "visits",
                "useLineColorForBulletBorder": true,
                "balloon":{
                    "drop":true
                }
            }],
            "chartScrollbar": {
                "autoGridCount": true,
                "graph": "g1",
                "scrollbarHeight": 40,
            },
            "chartCursor": {
               "limitToGraph":"g1"
            },
            "categoryField": "date",
            "categoryAxis": {
                "minPeriod": "ss",
                "parseDates": true,
                "axisColor": "#DADADA",
                "dashLength": 1,
                "minorGridEnabled": true
            },  
            "export": {
                "enabled": false
            } // Enable: true -> To export the duration selected. (PDF, JSON, ...)
        });
        // Create a AmCharts diagram. There are many tools with this type, like scroll bar, zoom, etc ..
        diag_table_history[sensor_id] = chart;
        create_event(sensor_id);
      } 

    function create_history_diagram_sensor(sensor_id){
        var chartData = [];
        var chart = AmCharts.makeChart(sensor_id+'_history', {
            "type": "serial",
            "theme": "light",
            "marginRight": 80,
            "autoMarginOffset": 20,
            "marginTop": 7,
            "dataProvider": chartData,
            "valueAxes": [{
                "axisAlpha": 0.2,
                "dashLength": 1,
                //"minimum": 0,  //BAD : Values can't be negative
                "position": "left"
            }],
            "mouseWheelZoomEnabled": true,
            "graphs": [{
                "id": "g1",
                "balloonText": "[[value]]",
                "bullet": "round",
                "bulletBorderAlpha": 1,
                "bulletColor": "#FFFFFF",
                "hideBulletsCount": 50,
                "title": "red line",
                "valueField": "visits",
                "useLineColorForBulletBorder": true,
                "balloon":{
                    "drop":true
                }
            }],
            "chartScrollbar": {
                "autoGridCount": true,
                "graph": "g1",
                "scrollbarHeight": 40,
            },
            "chartCursor": {
               "limitToGraph":"g1"
            },
            "categoryField": "date",
            "categoryAxis": {
                "minPeriod": "ss",
                "parseDates": true,
                "axisColor": "#DADADA",
                "dashLength": 1,
                "minorGridEnabled": true
            },  
            "export": {
                "enabled": false
            } // Enable: true -> To export the duration selected. (PDF, JSON, ...)
        });
        // Create a AmCharts diagram. There are many tools with this type, like scroll bar, zoom, etc ..
        diag_table_history[sensor_id] = chart;
        create_event(sensor_id);
      }

    function create_history_diagram_binary_sensor(sensor_id){
        var chartData = [];
        var chart = AmCharts.makeChart(sensor_id+'_history', {
            "type": "serial",
            "theme": "light",
            "marginRight": 80,
            "autoMarginOffset": 20,
            "marginTop": 7,
            "dataProvider": chartData,
            "valueAxes": [{
                "axisAlpha": 0.2,
                "dashLength": 1,
                "position": "left"
            }],
            "mouseWheelZoomEnabled": true,
            "graphs": [{
                "id": "g1",
                "balloonText": "[[value]]",
                "type": "step", // For digital diagram
                "bullet": "round",
                "bulletBorderAlpha": 1,
                "bulletColor": "#FFFFFF",
                "hideBulletsCount": 50,
                "title": "red line",
                "valueField": "visits",
                "useLineColorForBulletBorder": true,
                "balloon":{
                    "drop":true
                }
            }],
            "chartScrollbar": {
                "autoGridCount": true,
                "graph": "g1",
                "scrollbarHeight": 40
            },
            "chartCursor": {
               "limitToGraph":"g1"
            },
            "categoryField": "date",
            "categoryAxis": {
                "minPeriod": "ss",
                "parseDates": true,
                "axisColor": "#DADADA",
                "dashLength": 1,
                "minorGridEnabled": true
            },  
            "export": {
                "enabled": false
            } // Enable: true -> To export the duration selected. (PDF, JSON, ...)
        });
        // Create a AmCharts diagram. There are many tools with this type, like scroll bar, zoom, etc ..
        diag_table_history[sensor_id] = chart;
        create_event(sensor_id);
      } 
    function create_history_diagram_light(sensor_id){
        var chartData = [];
        var chart = AmCharts.makeChart(sensor_id+'_history', {
            "type": "serial",
            "theme": "light",
            "marginRight": 80,
            "autoMarginOffset": 20,
            "marginTop": 7,
            "dataProvider": chartData,
            "valueAxes": [{
                "axisAlpha": 0.2,
                "dashLength": 1,
                "position": "left"
            }],
            "mouseWheelZoomEnabled": true,
            "graphs": [{
                "id": "g1",
                "balloonText": "[[value]]",
                "type": "step", // For digital diagram
                "bullet": "round",
                "bulletBorderAlpha": 1,
                "bulletColor": "#FFFFFF",
                "hideBulletsCount": 50,
                "title": "red line",
                "valueField": "visits",
                "useLineColorForBulletBorder": true,
                "balloon":{
                    "drop":true
                }
            }],
            "chartScrollbar": {
                "autoGridCount": true,
                "graph": "g1",
                "scrollbarHeight": 40
            },
            "chartCursor": {
               "limitToGraph":"g1"
            },
            "categoryField": "date",
            "categoryAxis": {
                "minPeriod": "ss",
                "parseDates": true,
                "axisColor": "#DADADA",
                "dashLength": 1,
                "minorGridEnabled": true
            },  
            "export": {
                "enabled": false
            } // Enable: true -> To export the duration selected. (PDF, JSON, ...)
        });
        // Create a AmCharts diagram. There are many tools with this type, like scroll bar, zoom, etc ..
        diag_table_history[sensor_id] = chart;
        create_event(sensor_id);
      }   

    // Display the data on the diagram (if there is data)
    function print_history(sensor_id){
        // Get the period
        var start = moment(window.start_date).format('YYYY-MM-DD%20HH:mm:ss');
        var end = moment(window.end_date).format('YYYY-MM-DD%20HH:mm:ss');
        if(start == end) return notificate('Warning',"You can't select the same date to start and finish. Please try again.",'warning',5000);

    
        // Because the format is not the same for each sources. This is just to find the id to build the url for the query
        if (sensor_id != undefined){ // If the diagram has been created
            if(sensor_id[73] == '-' && sensor_id[60] == '-' && sensor_id[55] == '-' && sensor_id[50] == '-' && sensor_id[45] == '-'){
                var MetricId = sensor_id;
                var thing_global_id = sensor_id.slice(0,sensor_id.lastIndexOf('-'));
                //console.log('thing_global_id> '+thing_global_id);
            }else{
                console.log(sensor_id);
                var thing_global_id = sensor_id.slice(0,sensor_id.lastIndexOf('-'));
            }
            // Create the url
            var url_duration = start+'/'+end;
            var url = url_metric_history+sensor_id+'/'+url_duration;
            console.log(url_metric_history)
            console.log(sensor_id)
            console.log(url_duration)
            console.log(url);
            stop_realtime(); 
        }
        
        // Asynchronous reques.
        if(this == undefined) get_data_from_api_async(print_history, url, sensor_id);
        else{
            
            sensor_id = this.arguments[0];
            var chart = diag_table_history[sensor_id];
            var config = chart.config;

            console.log(chart)

            //Clear the data of the history diagram
            while(chart.dataProvider.length !=  0){
               chart.dataProvider.shift();
            }

            console.log(this); // This = result of the request
            // Parse the data
            var data_hist = JSON.parse(this.responseText);
            console.log(data_hist[0])
            
            //Just test the result
            if(data_hist.length == undefined) notificate('Error',data_hist[0].error, 'warning', 10000);
            else var hist_of_sensor = data_hist[0]['history'];// Get only the history
            if(hist_of_sensor.length < 1) notificate('Error','There is a problem with the history', 'warning', 5000);
            

            //Put all the data in correct format in an array
            var i = 0;
            while(i< hist_of_sensor.length){
                var date = hist_of_sensor[i].TimeCollect;//moment.utc(hist_of_sensor[i].TimeCollect).format('hh:mm:ss a');
                // console.log(date)
                var value = hist_of_sensor[i].Value;
                var type = data_hist[0]['history'][0].DataType;

                switch(type){
                    case 'int':
                    case 'string':
                        if(value === 'on') value = 1;
                        else if (value === 'off') value = 0;
                        break;
                    case 'sensor': break;
                    default: console.log("\n**********\nIDK this type. (diag_update)\n**********\n")
                        break;
                }

                //Push the data in the diagram
                chart.dataProvider.push( {
                    date: date,
                    visits: value
                  });
                //history_diag_update(sensor_id, type, chartData);
                i++;    
            }
            //Update the diagram with it data
            chart.validateData();
         }
      }
      
    
    // Create the datepickers button and it get methods
    function create_event(sensor_id){
        
        // We use Jquery so we can't use dots in ID here
        var sensor_id_date = sensor_id.replace(/\./g,'-');
        console.log('A> '+sensor_id_date);
        console.log('\nB> '+sensor_id);
      
        //Create the calendar
        $('#calendar-'+sensor_id_date).daterangepicker({ 
            timePicker: true, 
            timePickerIncrement: 1,
            startDate: moment().startOf('hour').subtract(24, 'hour'),
            endDate: moment(),
            locale: {
                format: 'MM/DD/YYYY h:mm A' 
            },
            maxDate: moment()
        });

        //Event : When the user click on the button 'apply'.
        $('#calendar-'+sensor_id_date).on('apply.daterangepicker', function() {
                //Get values and put them in global variable
                window.start_date = $('#calendar-'+sensor_id_date).data('daterangepicker').startDate;
                window.end_date = $('#calendar-'+sensor_id_date).data('daterangepicker').endDate;
                //console.log("Start : "+moment(window.start_date)+"\n"+"End : "+moment(window.end_date));
                print_history(sensor_id);
        });




        //Predefine date

        var start = moment().subtract(29, 'days');
        var end = moment();


        //Initialize predefine date
        $('#predefine_date-'+sensor_id_date+' span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));    
        $('#predefine_date-'+sensor_id_date).daterangepicker({
            startDate: start,
            endDate: end,
            ranges: {
               'Today': [moment(), moment()],
               'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
               'Last 7 Days': [moment().subtract(6, 'days'), moment()],
               'Last 30 Days': [moment().subtract(29, 'days'), moment()],
               'This Month': [moment().startOf('month'), moment().endOf('month')],
               'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
            }
        });

        //Event : When we select a duration
        $('#predefine_date-'+sensor_id_date).on('apply.daterangepicker', function() {
            //Get values and put them in global variable
            window.start_date = $('#predefine_date-'+sensor_id_date).data('daterangepicker').startDate;
            window.end_date = $('#predefine_date-'+sensor_id_date).data('daterangepicker').endDate;
            //console.log("Start : "+moment(window.start_date)+"\n"+"End : "+moment(window.end_date));
            print_history(sensor_id);
        });
        
        
  }
    
  
    
</script> 
</body>
</html>
